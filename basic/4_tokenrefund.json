{
    "blocks": [],
    "contracts": [
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract TokensTransfer {\n    data {\n        SenderId string \"optional\"\n        RecipientId string\n        Amount string\n    }\n    \n    conditions {\n        if !($SenderId == $key_id || (Size($SenderId) > 0 && $original_contract == \"voting_AcceptDecision\")) {\n            Println($SenderId, $original_contract)\n            error \"sender id error\"\n        }\n        var addressLen int\n        addressLen = 24\n        \n        $amount = Money($Amount)\n        if $SenderId == \"\"{\n            $SenderId = Sprintf(\"%v\", $key_id)\n        }\n        if $amount <= 0 {\n            error \"TokensTransfer. Amount less than or equal to zero\"\n        }\n        \n        if !HasPrefix($SenderId, \"-\") && Contains($SenderId, \"-\"){\n            // is address. convert to key id\n            $SenderId = Sprintf(\"%v\", AddressToId($SenderId))\n        }\n        if !HasPrefix($RecipientId, \"-\") && Contains($RecipientId, \"-\"){\n            // is address. convert to key id\n            $RecipientId = Sprintf(\"%v\", AddressToId($RecipientId))\n        }\n        \n        if Size($SenderId) > addressLen{\n            $SenderId = Sprintf(\"%v\", PubToID($SenderId))\n        }\n        if Size($RecipientId) > addressLen{\n            $RecipientId = Sprintf(\"%v\", PubToID($RecipientId))\n        }\n        \n        \n        var sender map\n        sender = DBFind(\"keys\").Where(\"id=?\", $SenderId).Row()\n        if !sender{\n            error \"TokensTransfer. Sender is invalid\"\n        }\n        if sender[\"block\"] == 1{\n            error \"Sender blocked\"\n        }\n        if sender[\"amount\"] < $amount{\n            error Sprintf(\"The number of tokens of the sender (%v) is not enough\", sender[\"amount\"])\n        }\n    }\n    \n    action {\n        DBUpdate(\"keys\", Int($SenderId),\"-amount\", $amount)\n        DBUpdate(\"keys\", Int($RecipientId),\"+amount\", $amount)\n        DBInsert(\"history\", \"sender_id,recipient_id,amount,block_id,txhash\", $SenderId, $RecipientId, $amount, $block, $txhash)\n    }\n}",
            "Name": "TokensTransfer"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract tokenrefund_Accept{\n    data{\n        Id string\n    }\n    \n    func refundAmount(victimId, attackerId, amount string){\n        TokensTransfer(\"SenderId,RecipientId,Amount\", attackerId, victimId, amount)\n        Println(Sprintf(\"ВОЗВРАТ ТОКЕНОВ (%v: %v => %v)\", amount, attackerId, victimId))\n    }\n    func unblockAccounts(victimId, attackerId string){\n        if victimId==0 {\n            error \"unblockAccounts. invalid victim key\"\n        }\n        if attackerId==0{\n            error \"unblockAccounts. invalid attacker key\"\n        }\n        DBUpdate(\"keys\", Int(victimId), \"block\", 0)\n        DBUpdate(\"keys\", Int(attackerId), \"block\", 0)\n        Println(Sprintf(\"РАЗБЛОКИРОВКА АККАУНТОВ (%v, %v)\", victimId, attackerId))\n    }\n    \n    conditions{\n        Println($this_contract, \"conditions\")\n        $tokenrefund = DBFind(\"tokenrefund\").Where(\"id=?\", $Id).Row()\n        if !$tokenrefund{\n            Println(\"tokenrefund не найден\")\n            error \"tokenrefund не найден\"\n        }\n    }\n    \n    action{\n        Println($this_contract, \"action\")\n        unblockAccounts($tokenrefund[\"victim_key_id\"],$tokenrefund[\"attacker_key_id\"])\n        refundAmount($tokenrefund[\"victim_key_id\"],$tokenrefund[\"attacker_key_id\"],$tokenrefund[\"amount\"])\n        // status 3: closed; result 2: the tokens returned\n        DBUpdate(\"tokenrefund\", Int($tokenrefund[\"id\"]), \"status,result\", 3,2)\n    }\n}",
            "Name": "tokenrefund_Accept"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract tokenrefund_Reject{\n    data{\n        Id string\n    }\n    \n    func unblockAccounts(victimId, attackerId string){\n        if victimId==0 {\n            error \"unblockAccounts. invalid victim key\"\n        }\n        if attackerId==0{\n            error \"unblockAccounts. invalid attacker key\"\n        }\n        DBUpdate(\"keys\", Int(victimId), \"block\", 0)\n        DBUpdate(\"keys\", Int(attackerId), \"block\", 0)\n        Println(Sprintf(\"РАЗБЛОКИРОВКА АККАУНТОВ (%v, %v)\", victimId, attackerId))\n    }\n    \n    conditions{\n        Println($this_contract, \"conditions\")\n        $tokenrefund = DBFind(\"tokenrefund\").Where(\"id=?\", $Id).Row()\n        if !$tokenrefund{\n            Println(\"tokenrefund не найден\")\n            error \"tokenrefund не найден\"\n        }\n    }\n    \n    action{\n        Println($this_contract, \"action\")\n        unblockAccounts($tokenrefund[\"victim_key_id\"],$tokenrefund[\"attacker_key_id\"])\n        // status 3: closed; 1: return cancelled\n        DBUpdate(\"tokenrefund\", Int($tokenrefund[\"id\"]), \"status,result\", 3,1)\n    }\n}",
            "Name": "tokenrefund_Reject"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract tokenrefund_Start{\n    data{\n        VictimAccount string\n        SuspectAccount string\n        Amount int\n        Note string\n        DateStart string \"date\"\n        DateEnd string \"date\"\n        DateNow string \"date\"\n        TimeNow string \"date\"\n    }\n    func blockAccounts(victimId, attackerId int){\n        if victimId==0 {\n            error \"unblockAccounts. invalid victim key\"\n        }\n        if attackerId==0{\n            error \"unblockAccounts. invalid attacker key\"\n        }\n        DBUpdate(\"keys\", victimId, \"block\", 1)\n        DBUpdate(\"keys\", attackerId, \"block\", 1)\n        Println(Sprintf(\"БЛОКИРОВКА АККАУНТОВ (%v, %v)\", victimId, attackerId))\n    }\n    \n    conditions{\n        Println($this_contract, \"conditions\")\n        \n        $victimId = AddressToId($VictimAccount)\n        $attackerId = AddressToId($SuspectAccount)\n        if $Amount <= 0{\n            info \"Amount not valid\"\n        }\n        if $victimId == 0{\n            info \"Victim address not valid\"\n        }\n        if $attackerId == 0{\n            info \"Suspect address not valid\"\n        }\n        if Size($Note) == 0{\n            info \"Please add description\"\n        }\n        \n        if !DBFind(\"roles_participants\").Where(\"role->name='Validator' and role->type='3' and deleted=0 and member->member_id=?\", $key_id).Row(){\n            // commented out for debug\n            // warning \"You not Validator. You can not to run this\"\n        }\n        var app_id int\n        app_id = Int(DBFind(\"applications\").Columns(\"name,id\").Where(\"name='Basic application'\").One(\"id\"))\n        var template_id int\n        template_id = Int(AppParam(app_id,\"voting_tokenrefund_template_id\"))\n        if  template_id <= 0 {\n            warning \"Template id not found\"\n        }\n        // template_id = DBFind(\"laws\").Where(\"name='tokenrefund'\").One(\"voting_template_id\")\n        // if !template_id {\n        // template_id = DBFind(\"voting_templates\").Where(\"type='law' and type_id=1\").One(\"id\")\n        // if !template_id{\n        // info \"Template not found\"\n        // }\n        // }\n        \n        $template = DBFind(\"voting_templates\").Where(\"id=?\", template_id).Row()\n        $votersRoleId = Int($template[\"voters\"])\n        $votingName = $template[\"title\"]\n        $typeParticipants = 3 // add participants by role\n        $typeDecision = 5 // the launch of the contract\n        $typeVoting = 2 // the voting system\n        $volume = Int($template[\"volume\"])\n        $quorum = Int($template[\"quorum\"])\n        $contractAccept = $template[\"contract_accept\"]\n        $contractReject = $template[\"contract_reject\"]\n        \n        $desc = Sprintf(\"%v (victim: %v, attacker: %v, amount: %v)\", $votingName, $VictimAccount, $SuspectAccount, $Amount)\n        \n        if !DBFind(\"roles_participants\").Where(\"role->id=? and deleted=0\", $votersRoleId).One(\"id\") {\n            warning Sprintf(\"Role (id: %v) does not contain members\", $votersRoleId)\n        }\n        \n        if DBFind(\"votings\").Where(\"voting->name=? and voting->description=? and deleted=0\", $votingName, $desc).Row(){\n            // info \"Voting already created\" // debug: uncomment on the prod\n        }\n    }\n    \n    action{\n        Println($this_contract, \"action\")\n        blockAccounts($victimId,$attackerId)\n        \n        var votingId, status, result, tokenrefundId, roleId, closure, sender int\n        var icon, header, body, page, params, jsonParams string\n        \n        votingId = voting_CreateNew(\"voting_name,voting_type,description,type_participants,type_decision,volume,quorum,now_date,start_time,end_time,start_date,end_date\", $votingName, $typeVoting, $desc, $typeParticipants, $typeDecision, $volume, $quorum, $DateNow, $TimeNow, $TimeNow, $DateStart, $DateEnd)\n        \n        status = 1 // 0.Accounts blocked 1.Discussion 2.Vote 3.Closed\n        result = 0 // 0. discussion and voting 1. cancelled return 2. the tokens returned\n        tokenrefundId = DBInsert(\"tokenrefund\", \"victim_key_id,attacker_key_id,amount,note,validator_key_id,blocked_at,voting_id,status,result\", $victimId, $attackerId, $Amount, $Note, $key_id, $DateNow, votingId,status,result)\n        \n        jsonParams = Sprintf(`{\"Id\":\"%v\"}`, tokenrefundId)\n        \n        voting_SubjectContract(\"votingID,contract_reject,contract_accept,contract_reject_params,contract_accept_params\", votingId, $contractReject, $contractAccept, jsonParams, jsonParams)\n        \n        voting_Invite(\"votingID,var_id\", votingId, $votersRoleId)\n        \n        closure = 2\n        sender = 1 // from member\n        icon = \"icon-bubbles\"\n        header = \"$tokenrefund_note_header$\"\n        body = $desc\n        page = \"voting_view\"\n        params = Sprintf(`{\"vID\":\"%v\"}`, votingId)\n        Notifications_Roles_Send_str(\"rid,closure_type,sender,icon_name,text_header,text_body,page_name,params_val\", $votersRoleId, closure, sender, icon, header, body, page, params)\n    }\n}",
            "Name": "tokenrefund_Start"
        }
    ],
    "data": [
        {
            "Table": "voting_templates",
            "Columns": [
                "volume",
                "init_contract",
                "contract_reject",
                "contract_accept",
                "title",
                "vacancies",
                "candidates",
                "reject_params",
                "type_decision",
                "type_voting",
                "type_participants",
                "quorum",
                "voters",
                "subject",
                "accept_params"
            ],
            "Data": [
                [
                    "70",
                    "",
                    "tokenrefund_Reject",
                    "tokenrefund_Accept",
                    "Token Refund",
                    "0",
                    "0",
                    "0",
                    "0",
                    "0",
                    "3",
                    "51",
                    "4",
                    "",
                    ""
                ]
            ]
        }
    ],
    "languages": [
        {
            "Name": "blocked_at",
            "Trans": "{\"en\": \"Date of lock\", \"ru\": \"Дата блокировки\"}"
        },
        {
            "Name": "description",
            "Trans": "{\"en\": \"Description\", \"ru\": \"Описание\"}"
        },
        {
            "Name": "request_refund",
            "Trans": "{\"en\": \"To request a refund\", \"ru\": \"Запросить возврат средств\"}"
        },
        {
            "Name": "result",
            "Trans": "{\"en\": \"Result\", \"ru\": \"Результат\"}"
        },
        {
            "Name": "sender",
            "Trans": "{\"en\": \"Sender\", \"ru\": \"Отправитель\"}"
        },
        {
            "Name": "start_refund",
            "Trans": "{\"en\": \"To start the refund\", \"ru\": \"Начать возврат средств\"}"
        },
        {
            "Name": "tokenrefund_attacker",
            "Trans": "{\"en\": \"Attacker\", \"ru\": \"Злоумышленник\"}"
        },
        {
            "Name": "tokenrefund_list",
            "Trans": "{\"en\": \"Tokens refund list\", \"ru\": \"Список возврата токенов\"}"
        },
        {
            "Name": "tokenrefund_note_header",
            "Trans": "{\"en\": \"Token refund\", \"ru\": \"Возврат средств\"}"
        },
        {
            "Name": "tokenrefund_result0",
            "Trans": "{\"en\": \"Discussion and voting\", \"ru\": \"Oбсуждение и голосование\"}"
        },
        {
            "Name": "tokenrefund_result1",
            "Trans": "{\"en\": \"Return cancelled\", \"ru\": \"Возврат отменен\"}"
        },
        {
            "Name": "tokenrefund_result2",
            "Trans": "{\"en\": \"The tokens returned\", \"ru\": \"Токены возвращены\"}"
        },
        {
            "Name": "tokenrefund_start",
            "Trans": "{\"en\": \"Refund\", \"ru\": \"Возврат средств\"}"
        },
        {
            "Name": "tokenrefund_status0",
            "Trans": "{\"en\": \"Blocked accounts\", \"ru\": \"Аккаунты заблокированы\"}"
        },
        {
            "Name": "tokenrefund_status1",
            "Trans": "{\"en\": \"Discussion\", \"ru\": \"Обсуждение\"}"
        },
        {
            "Name": "tokenrefund_status2",
            "Trans": "{\"en\": \"Voting\", \"ru\": \"Голосование\"}"
        },
        {
            "Name": "tokenrefund_status3",
            "Trans": "{\"en\": \"Closed\", \"ru\": \"Закрыто\"}"
        },
        {
            "Name": "tokenrefund_victim",
            "Trans": "{\"en\": \"Victim\", \"ru\": \"Жертва\"}"
        },
        {
            "Name": "voting",
            "Trans": "{\"en\": \"Voting\", \"ru\": \"Голосование\"}"
        }
    ],
    "menus": [
        {
            "Conditions": "ContractAccess(\"@1EditMenu\")",
            "Value": "MenuItem(Title:$tokenrefund_list$, Page:tokenrefund_list, Icon:\"icon-list\")\nMenuItem(Title:$tokens_transfer$, Page:tokens_transfer, Icon:\"icon-credit-card\")",
            "Name": "default_menu"
        }
    ],
    "pages": [
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(Name:applications, Source:src_app).Columns(\"name,id\").Where(\"name='Basic application'\").Vars(app)\nDiv(content-wrapper){\n    SetTitle($tokenrefund_list$)\n    \n    DBFind(Name: tokenrefund, Source: src).Order(id desc).Custom(_status){\n        If(#status#>0){\n            AppParam(App:#app_id#, Name: tokenrefund_status, Index: #status#)\n        }.Else{\n            $tokenrefund_status0$\n        }\n    }.Custom(_result){\n        If(#result#>0){\n            AppParam(App:#app_id#, Name: tokenrefund_result, Index: #result#)\n        }.Else{\n            $tokenrefund_result0$\n        }\n    }.Custom(_blocked){\n        DateTime(Format: YYYY-MM-DD HH:MI:SS, DateTime: #blocked_at#)\n    }.Custom(_closed){\n        DateTime(Format: YYYY-MM-DD HH:MI:SS, DateTime: #closed_at#)\n    }.Custom(_accounts){\n        Div(){$tokenrefund_victim$: #victim_key_id#}\n        Div(){$tokenrefund_attacker$: #attacker_key_id#}\n    }.Custom(_voting){\n        LinkPage(Page: voting_view, PageParams: \"vID=#voting_id#\"){##voting_id#}\n    }\n    \n    Div(panel panel-primary){\n        Div(table-responsive){\n            Table(Source: src, Columns: \"$accounts$=_accounts,$amount$=amount,$description$=note,$validator_id$=validator_id,$blocked_at$=_blocked,$voting$=_voting,$result$=_result,$status$=_status,$closed$=_closed\")\n        }   \n        \n        Form(panel-footer text-right){\n            Button(Body: $request_refund$, Class: btn btn-primary, Page: tokenrefund_start)\n        }\n    }\n}\n\n",
            "Name": "tokenrefund_list",
            "Menu": "default_menu"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Data(Source: inputs, Columns:\"name,type,res,placeholder\"){\n    Amount,number,amount,\"\"\n    VictimAccount,text,tokenrefund_victim,xxxx-xxxx-xxxx-xxxx-xxxx\n    SuspectAccount,text,tokenrefund_attacker,xxxx-xxxx-xxxx-xxxx-xxxx\n    Note,textarea,description,\"\"\n}\nDiv(content-wrapper){\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading, Body: $tokenrefund_start$)\n                Div(panel-body){\n                    ForList(Source: inputs){\n                        Div(row form-group){\n                            Div(col-sm-4){LangRes(#res#)}\n                            Div(col-sm-8){\n                                Input(Name: #name#, Type: #type#, Placeholder: #placeholder#)\n                            }\n                        }\n                    }\n                }\n                Div(panel-footer text-right){\n                    Input(Name: DateStart, Type: hidden, Value: Now(\"YYYY-MM-DD\", +1 day))\n                    Input(Name: DateEnd, Type: hidden, Value: Now(\"YYYY-MM-DD\", +2 day))\n                    Input(Name: DateNow, Type: hidden, Value: Now(\"YYYY-MM-DD HH:MI\"))\n                    Input(Name: TimeNow, Type: hidden, Value: Now(\"HH:MI\"))\n                    Button(Body: $start_refund$, Contract: tokenrefund_Start, Page: tokenrefund_list, Class: btn btn-primary)\n                }\n            }\n        }\n    }\n}",
            "Name": "tokenrefund_start",
            "Menu": "default_menu"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetTitle($tokens_transfer$)\nData(inputs, \"name,res\"){\n    RecipientId,recipient\n    Amount,amount\n}\nDiv(content-wrapper){\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading, Body: LangRes(tokens_transfer))\n                Div(panel-body){\n                    ForList(inputs){\n                        Div(form-group){\n                            Div(row){\n                                Div(col-md-3 text-right){Label(LangRes(#res#))}\n                                Div(col-md-9 text-left){\n                                    Input(Name: #name#, Value: \"\")\n                                }\n                            }\n                        }\n                    }\n                }\n                Div(panel-footer text-right){\n                    Input(Name:SenderId, Value: #key_id#, Type:hidden)\n                    Button(Body: LangRes(send), Class: btn btn-primary, Page: tokens_transfer, Contract: TokensTransfer).Alert(Text: $want_send_tokens$, ConfirmButton: $yes$, CancelButton: $no$, Icon: question)\n                }\n            }\n        }\n    }\n    DBFind(keys, src).Order(id).Custom(_address){\n        If(#id#==#key_id#){\n            Div(text-success){\n                Address(#id#)\n            }\n        }.Else{\n            Address(#id#)\n        }\n    }\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Table(src, \"=_address,Amount=amount\")\n        }\n    }\n    \n}",
            "Name": "tokens_transfer",
            "Menu": "default_menu"
        }
    ],
    "parameters": [
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "tokenrefund_result1,tokenrefund_result2,tokenrefund_result3",
            "Name": "tokenrefund_result"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "tokenrefund_status1,tokenrefund_status2,tokenrefund_status3",
            "Name": "tokenrefund_status"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Name": "voting_tokenrefund_template_id"
        }
    ],
    "tables": [
        {
            "Name": "laws",
            "Columns": "[\n    {\n        \"name\": \"name\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"page\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"voting_template_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "tokenrefund",
            "Columns": "[\n    {\n        \"name\": \"victim_key_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"attacker_key_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"amount\",\n        \"type\": \"money\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"note\",\n        \"type\": \"text\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"validator_key_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"blocked_at\",\n        \"type\": \"datetime\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"voting_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"result\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"status\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"closed_at\",\n        \"type\": \"datetime\",\n        \"conditions\": \"true\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        }
    ]
}