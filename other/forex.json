{
    "name": "Forex",
    "data": [
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "MenuItem(Title: Forex, Page: forex)",
            "Name": "default_menu",
            "Type": "menu"
        },
        {
            "Name": "forex_history",
            "Columns": "[\n    {\n        \"name\": \"price\",\n        \"type\": \"money\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"total\",\n        \"type\": \"money\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"amount\",\n        \"type\": \"money\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"currency\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"direction\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"time\",\n        \"type\": \"datetime\",\n        \"conditions\": \"true\"\n    }\n]",
            "Permissions": "{\"insert\": \"ContractConditions(\\\"MainCondition\\\")\", \"update\": \"ContractConditions(\\\"MainCondition\\\")\", \"new_column\": \"ContractConditions(\\\"MainCondition\\\")\"}",
            "Type": "tables"
        },
        {
            "Name": "forex_orders",
            "Columns": "[\n    {\n        \"name\": \"sell_table_account_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"amount\",\n        \"type\": \"money\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"buy_table\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"sell_rate\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"sell_table\",\n        \"type\": \"varchar\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"empty_block_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    },\n    {\n        \"name\": \"buy_table_account_id\",\n        \"type\": \"number\",\n        \"conditions\": \"true\"\n    }\n]",
            "Permissions": "{\"insert\": \"true\", \"update\": \"true\", \"new_column\": \"true\"}",
            "Type": "tables"
        },
        {
            "Conditions": "true",
            "Value": "SetTitle(Forex)\r\n\r\nDiv(content-wrapper){\r\n    SetVar(Table1,global_euro).(Table2,keys).(global,1).(Currency1,EURO).(Currency2,USD)\r\n\r\n    DBFind(#Table1#, amount).Columns(amount).Where(\"member_id=#key_id#\").Vars(buy_items)\r\n    Form(panel panel-default){\r\n        Div(panel-body){\r\n            Label(\"BUY #Currency1#\")\r\n            Input(Name: Direction, Type: hidden, Value: buy)\r\n            Input(Name: SellTable, Type: hidden, Value: #Table2#)\r\n            Input(Name: BuyTable, Type: hidden, Value: #Table1#)\r\n            Div(form-group){\r\n                Div(col-md-4 text-right){Your balance}\r\n                Div(col-md-4 text-left){#buy_items_amount#}\r\n                Div(col-md-4){#Currency2#}\r\n            }\r\n            Div(form-group){\r\n                Div(col-md-4 text-right){Amount #Currency1#}\r\n                Div(col-md-4){Input(Name:Amount)}\r\n            }\r\n\r\n            Div(form-group){\r\n                Div(col-md-4 text-right){Price per #Currency1#}\r\n                Div(col-md-4){\r\n                    Input(Name:SellRate, \"form-control\")\r\n                }\r\n                Div(col-md-4){#Currency2#}\r\n            }\r\n            Button(Contract: forex_NewOrder, Page: forex, PageParams: \"global=1,Table1='global_euro',Table2='1_accounts',Currency1='EURO',Currency2='USD'\")\r\n\r\n        }\r\n    }\r\n\r\n\r\n    DBFind(forex_orders,sell_orders).Order(\"sell_rate ASC\").Where(\"sell_table='#Table2#' and (empty_block_id is NULL or empty_block_id=0)\").Custom(Price){\r\n        #sell_rate#\r\n    }.Custom(Amount){\r\n        #amount# #Currency1#\r\n    }.Custom(Total){\r\n        Calculate(#amount#*#sell_rate#) #Currency2#\r\n    }\r\n    DBFind(#Table1#, amount).Columns(amount).Where(\"member_id=#key_id#\").Vars(sell_items)\r\n    Form(panel panel-default){\r\n        Div(panel-heading){SELL #Currency1#}\r\n        Div(panel-body){\r\n            Input(Name: SellTable, Type: hidden, Value: #Table1#)\r\n            Input(Name: BuyTable, Type: hidden, Value: #Table2#)\r\n            Input(Name: Direction, Type: hidden, Value: sell)\r\n            Div(row form-group){\r\n                Div(col-md-4 text-right){Your balance}\r\n                Div(col-md-4 text-left){#sell_items_amount#}\r\n                Div(col-md-4){#Currency1#}\r\n            }\r\n\r\n            Div(row form-group){\r\n                Div(col-md-4 text-right){Amount #Currency1#}\r\n                Div(col-md-4){\r\n                    Input(Name:Amount)\r\n                }\r\n            }\r\n\r\n            Div(row form-group){\r\n                Div(col-md-4 text-right){Price per #Currency1#}\r\n                Div(col-md-4){\r\n                    Input(Name:SellRate)\r\n                }\r\n                Div(col-md-4){#Currency2#}\r\n                Button(Contract: forex_NewOrder, Page: forex, PageParams: \"global=1,Table1='global_euro',Table2='1_accounts',Currency1='EURO',Currency2='USD'\")\r\n\r\n            }\r\n        }\r\n    }\r\n\r\n    Div(panel panel-default){\r\n        Div(panel-heading){Sell orders}\r\n        Div(panel-body){\r\n            Table(sell_orders, \"Price,Amount,Total\")\r\n        }\r\n    }\r\n\r\n\r\n    DBFind(forex_orders, buy_orders).Order(\"sell_rate DESC\").Where(\"sell_table='#Table1#' and (empty_block_id is NULL or empty_block_id=0)\").Custom(Price){\r\n        #sell_rate#\r\n    }.Custom(Amount){\r\n        #amount# #Currency1#\r\n    }.Custom(Total){\r\n        Calculate(#amount#*#sell_rate#) #Currency2#\r\n    }\r\n    Div(panel panel-default){\r\n        Div(panel-heading){\"Buy orders\"}\r\n        Div(panel-body){\r\n            Table(buy_orders, \"Price,Amount,Total\")\r\n        }\r\n    }\r\n\r\n    DBFind(forex_history, history).Order(\"time DESC\").Where(\"currency='#Table1#' or currency='#Table2#'\").Custom(Time){\r\n        DateTime(#time#)\r\n    }.Custom(Type){\r\n        If(#direction#==\"sell\"){\r\n            Div(text-bold text-danger){sell}\r\n        }.Else{\r\n            Div(text-bold text-success){buy}\r\n        }\r\n    }.Custom(Price){\r\n        #price# #Currency2#\r\n    }.Custom(Amount){\r\n        #amount# #Currency1#\r\n    }.Custom(Total){\r\n        #total# #Currency2#\r\n    }\r\n    Div(panel panel-default){\r\n        Div(panel-heading){Trade history}\r\n        Div(panel-body){\r\n            Table(history, \"Time,Type,Price,Amount,Total\")\r\n        }\r\n    }\r\n}",
            "Name": "forex",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "true",
            "Value": "contract newForexOrder {\r\n    data {\r\n        SellTable string\r\n        SellRate float\r\n        Amount money\r\n        BuyTable string\r\n        Direction string\r\n    }\r\n\r\n    conditions {\r\n        if $SellTable == $BuyTable {\r\n            warning \"SellTable == BuyTable\"\r\n        }\r\n        if $SellRate == 0 || $Amount == 0 {\r\n            warning \"SellRate == 0\"\r\n        }\r\n        if $Amount * $SellRate < 1 {\r\n            warning \"<1\"\r\n        }\r\n        var amount forexAmount money account_id int\r\n\r\n        amount = Money(DBFind($SellTable).Where(\"member_id=?\", $key_id).One(\"amount\"))\r\n        account_id = DBFind($SellTable).Where(\"id=?\", $key_id).One(\"id\")\r\n        forexAmount = DBFind(\"forex_orders\").Where(\"sell_table = $ AND sell_table_account_id = $\", $SellTable, account_id).One(\"sum(amount)\")\r\n        if amount+forexAmount < $Amount {\r\n            warning \"not enough money \"\r\n        }\r\n\r\n    }\r\n\r\n    action {\r\n        var reverseRate float totalSellAmount money\r\n        reverseRate = 1.0 / $SellRate\r\n        totalSellAmount = $Amount\r\n\r\n        var list array data1 map i len int\r\n\r\n        list = DBFind(\"forex_orders\").Order(\"id desc\").Where(\"buy_table=$ AND sell_rate>=$ AND sell_table=$ AND (empty_block_id=0 OR empty_block_id is NULL)\", $BuyTable, reverseRate, $SellTable)\r\n        len = Len(list)\r\n        while i < len {\r\n            data1 = list[i]\r\n            i = i + 1\r\n            var readyToBuy sellerSellAmount money\r\n            readyToBuy = totalSellAmount * data1[\"sell_rate\"]\r\n            if readyToBuy >= data1[\"amount\"] {\r\n                sellerSellAmount = data1[\"amount\"] // ордер будет закрыт, а мы продолжим искать новые\r\n            } else {\r\n                sellerSellAmount = readyToBuy // данный ордер удовлетворяет наш запрос целиком\r\n            }\r\n            if data1[\"amount\"] - sellerSellAmount < 1 { // ордер опустошили\r\n                DBUpdate(\"forex_orders\", Int(data1[\"id\"]), \"amount,empty_block_id\", \"0\", $block)\r\n                DBInsert(\"forex_history\", \"price,amount,total,direction,currency,timestamp time\", data1[\"sell_rate\"], data1[\"amount\"], Money(data1[\"amount\"])*Float(data1[\"sell_rate\"]), $Direction, $BuyTable, $block_time)\r\n\r\n            } else {\r\n                // вычитаем забранную сумму из ордера\r\n                var rowAmount money\r\n                rowAmount = Money(DBFind(\"forex_orders\").Where(\"id=?\", data1[\"id\"]).One(\"amount\"))\r\n                DBUpdate(\"forex_orders\", Int(data1[\"id\"]), \"amount\", rowAmount - sellerSellAmount)\r\n                DBInsert(\"forex_history\", \"price,amount,total,direction,currency,timestamp time\", data1[\"sell_rate\"], sellerSellAmount, Money(sellerSellAmount)*Float(data1[\"sell_rate\"]), $Direction, $BuyTable, $block_time)\r\n            }\r\n            var sellerBuyAmount money\r\n            sellerBuyAmount = sellerSellAmount * (1.0 / data1[\"sell_rate\"])\r\n\r\n            var sender_id recipient_id int\r\n            \r\n\t\t\tsender_id = data1[\"sell_table_account_id\"]\r\n            recipient_id = Int(DBFind(data1[\"sell_table\"]).Where(\"id=?\", $key_id).One(\"id\"))\r\n\t\t\tTokenTransfer(Int(sender_id), recipient_id, sellerSellAmount)\r\n\r\n            sender_id = Int(DBFind(data1[\"buy_table\"]).Where(\"id=?\", $key_id).One(\"id\"))\r\n            recipient_id = Int(data1[\"buy_table_account_id\"])\r\n\r\n            TokenTransfer(sender_id, recipient_id, sellerBuyAmount)\r\n\r\n            // вычитаем с нашего баланса сумму, которую потратили на данный ордер\r\n            totalSellAmount = totalSellAmount - sellerBuyAmount\r\n            if totalSellAmount < 1 {\r\n                break // проход по ордерам прекращаем, т.к. наш запрос удовлетворен\r\n            }\r\n        }\r\n\r\n        if totalSellAmount >= 0.01 {\r\n            var sell_account_id buy_account_id int\r\n            sell_account_id = Int(DBFind($SellTable).Where(\"id=?\", $key_id).One(\"id\"))\r\n            buy_account_id = Int(DBFind($BuyTable).Where(\"id=?\", $key_id).One(\"id\"))\r\n\t\t\t\r\n            DBInsert(\"forex_orders\", \"sell_rate,amount,sell_table_account_id,sell_table,buy_table_account_id,buy_table\", $SellRate, totalSellAmount, sell_account_id, $SellTable, buy_account_id, $BuyTable)\r\n        }\r\n    }\r\n}",
            "Name": "forex_NewOrder",
            "Type": "contracts"
        }
    ]
}