{
    "blocks": [],
    "contracts": [
        {
            "Name": "referendums_accept",
            "Value": "contract referendums_accept {\n    data {\n        referendum_id int\n    }\n\n    conditions {\n        $referendums_map = DBFind(\"referendums\").Where(\"id=$\", $referendum_id).Row()\n        if ($referendums_map[\"id\"] == nil) {\n            warning \"Referendum not found\"\n        }\n\n\t\t$participant_id = DBFind(\"referendums_participants\").Where(\"referendum_id=$ and member_id=$\", $referendum_id, $key_id).One(\"id\")\n        if ($participant_id != nil){\n\t\t\twarning \"You already voted\"\n\t\t}\n\n        $votes_total = Int($referendums_map[\"votes_total\"])\n        $votes_accept = Int($referendums_map[\"votes_accept\"])\n        $votes_reject = Int($referendums_map[\"votes_reject\"])\n        $percent_accept = Int($referendums_map[\"percent_accept\"])\n        $percent_reject = Int($referendums_map[\"percent_reject\"])\n    }\n\n    action {\n        $votes_total = $votes_total + 1\n        $votes_accept = $votes_accept + 1\n\n        $percent_accept = $votes_accept * 100 / $votes_total\n        $percent_reject = 100 - $percent_accept\n\n        DBUpdate(\"referendums\", $referendum_id, \"votes_total,votes_accept,votes_reject,percent_accept,percent_reject\", $votes_total, $votes_accept, $votes_reject, $percent_accept, $percent_reject)\n        DBInsert(\"referendums_participants\", \"referendum_id,member_id,decision\", $referendum_id, $key_id, 1)\n\n        var params string\n        params = \"referendum_id=\" + Str($referendum_id)\n        $notific_id = DBFind(\"notifications\").Where(\"page_name=$ and page_params=$ and recipient_id=$ and closed=$\", \"referendums_view\", params, $key_id, 0).One(\"id\")\n        if ($notific_id != nil){\n            Notifications_Single_Close(\"notific_id\", Int($notific_id))\n\t\t}\n    }\n}",
            "Conditions": "ContractConditions(\"MainCondition\")"
        },
        {
            "Name": "referendums_add",
            "Value": "contract referendums_add {\n    data {\n        referendum_name string\n        question string\n    }\n\n    conditions {}\n\n    action {\n        $referendum_id = DBInsert(\"referendums\", \"name,question\", $referendum_name, $question)\n\n        $ret_member = DBFind(\"members\").Where(\"id != $\", 0).Order(\"id\")\n        $i = 0\n        while($i < Len($ret_member)){\n            $vals_member = $ret_member[$i]\n            \n\t\t\tvar params string\n\t\t\tparams = \"referendum_id=\" + Str($referendum_id)\n            \n\t\t\tNotifications_Single_Send(\"member_id,icon_name,text_header,text_body,page_name,params_val\", \n\t\t\t\t\t\t\t\t$vals_member[\"id\"], \"fa-check\", \"Referendum\", $referendum_name, \"referendums_view\", params)\n\n            $i = $i + 1\n        } \n\n    }\n}",
            "Conditions": "ContractConditions(\"MainCondition\")"
        },
        {
            "Name": "referendums_reject",
            "Value": "contract referendums_reject {\n    data {\n        referendum_id int\n    }\n\n    conditions {\n        $referendums_map = DBFind(\"referendums\").Where(\"id=$\", $referendum_id).Row()\n        if ($referendums_map[\"id\"] == nil) {\n            warning \"Referendum not found\"\n        }\n\n\t\t$participant_id = DBFind(\"referendums_participants\").Where(\"referendum_id=$ and member_id=$\", $referendum_id, $key_id).One(\"id\")\n        if ($participant_id != nil){\n\t\t\twarning \"You already voted\"\n\t\t}\n\n        $votes_total = Int($referendums_map[\"votes_total\"])\n        $votes_accept = Int($referendums_map[\"votes_accept\"])\n        $votes_reject = Int($referendums_map[\"votes_reject\"])\n        $percent_accept = Int($referendums_map[\"percent_accept\"])\n        $percent_reject = Int($referendums_map[\"percent_reject\"])\n    }\n\n    action {\n        $votes_total = $votes_total + 1\n        $votes_reject = $votes_reject + 1\n\n        $percent_accept = $votes_accept * 100 / $votes_total\n        $percent_reject = 100 - $percent_accept\n\n        DBUpdate(\"referendums\", $referendum_id, \"votes_total,votes_accept,votes_reject,percent_accept,percent_reject\", $votes_total, $votes_accept, $votes_reject, $percent_accept, $percent_reject)\n        DBInsert(\"referendums_participants\", \"referendum_id,member_id,decision\", $referendum_id, $key_id, -1)\n\n        var params string\n        params = \"referendum_id=\" + Str($referendum_id)\n        $notific_id = DBFind(\"notifications\").Where(\"page_name=$ and page_params=$ and recipient_id=$ and closed=$\", \"referendums_view\", params, $key_id, 0).One(\"id\")\n        if ($notific_id != nil){\n            Notifications_Single_Close(\"notific_id\", Int($notific_id))\n\t\t}\n    }\n}",
            "Conditions": "ContractConditions(\"MainCondition\")"
        }
    ],
    "data": [],
    "languages": [
        {
            "Name": "referendum",
            "Conditions": "",
            "Trans": "{\"en\":\"Referendum\",\"ru\":\"Референдум\"}"
        },
        {
            "Name": "total_votes",
            "Conditions": "",
            "Trans": "{\"en\":\"Total votes\",\"ru\":\"Всего проголосовало\"}"
        },
        {
            "Name": "votes_taken_accept",
            "Conditions": "",
            "Trans": "{\"ru\":\"Положительных голосов\",\"en\":\"Positive votes\"}"
        },
        {
            "Name": "votes_taken_reject",
            "Conditions": "",
            "Trans": "{\"ru\":\"Отрицательных голосов\",\"en\":\"Negative votes\"}"
        }
    ],
    "menus": [
        {
            "Name": "default_menu",
            "Value": "MenuItem(Title:$referendum$, Page:referendums_list, Icon:\"fa fa-gavel\")",
            "Conditions": "ContractAccess(\"@1EditMenu\")"
        }
    ],
    "pages": [
        {
            "Name": "referendums_add",
            "Value": "Div(Class: content-wrapper){\r\n\r\n\tSetTitle($new_voting$)\r\n\tDiv(Class: breadcrumb){\r\n\t\tLinkPage($referendum$, referendums_list)\r\n\t\tSpan(/).Style(margin-right: 10px; margin-left: 10px;)\r\n\t\tSpan(Class: text-muted, Body: $new_voting$)\r\n\t}\r\n\r\n    Div(Class: row df f-valign){\r\n        Div(Class: col-md-3)\r\n        Div(Class: col-md-6){\r\n\t\t\r\n            Div(Class: panel panel-primary){\r\n                Div(Class: panel-heading, Body: LangRes(new_voting))\r\n                Form(){\r\n\r\n                    Div(Class: list-group-item){\r\n                        Div(Class: row df f-valign){\r\n                \t\t\tDiv(Class: col-md-3 mt-sm text-right){\r\n                                Label(For: referendum_name){\r\n                                    Span(Body: LangRes(name))\r\n                                }\r\n                \t\t\t}\r\n                \t\t\tDiv(Class: col-md-9 mc-sm text-left){\r\n                \t\t\t    Input(Name: referendum_name, Class: form-control, Type: text)\r\n                \t\t\t}\r\n                        }                   \r\n                    }\r\n\r\n                    Div(Class: list-group-item){\r\n                        Div(Class: row df f-valign){\r\n                \t\t\tDiv(Class: col-md-3 mt-lg text-right){\r\n                                Label(For: question){\r\n                                    Span(Body: LangRes(description))\r\n                                }\r\n                            }\r\n                \t\t\tDiv(Class: col-md-9 mc-sm text-left){\r\n                \t\t\t    Input(Name: question, Class: form-control, Type: textarea)\r\n                \t\t\t}\r\n                        }                      \r\n                    }\r\n\r\n                    Div(Class: panel-footer clearfix){\r\n                        Div(Class: pull-right){\r\n                            Button(Body: LangRes(back), Class: btn btn-default, Page: referendums_list)\r\n                            Button(Body: LangRes(create), Class: btn btn-primary, Page: referendums_list, Contract: referendums_add)\r\n                        }\r\n                    }\r\n\r\n                }\r\n            }\r\n\t\t}\r\n\t\tDiv(Class: col-md-3)\r\n    }\r\n}",
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Menu": "default_menu"
        },
        {
            "Name": "referendums_list",
            "Value": "Div(Class: content-wrapper){\r\n    \r\n    SetTitle($referendum$)\r\n    Div(breadcrumb){\r\n        Span(Class: text-muted, Body: $referendum$)\r\n    }\r\n    \r\n    If(GetVar(isSearch) == 1){\r\n        SetVar(Name: v_Where, Value: \"name='#v_Search#' and delete = 0\")\r\n    }.Else{\r\n        SetVar(Name: v_Where, Value: \"delete=0\")\r\n        SetVar(Name: v_Search, Value: \"\")\r\n    }\r\n    \r\n    DBFind(Name: referendums, Source: src_referendums).Custom(custom_id){\r\n\t\tSpan(#id#)\r\n    }.Custom(custom_name){\r\n        LinkPage(Page: referendums_view, PageParams: \"referendum_id=#id#\"){\r\n            Span(Class: h4 text-bold, Body: #name#)\r\n        }\r\n    }.Custom(custom_all){\r\n        Span(Class: h5, Body: #votes_total#)\r\n    }.Custom(custom_accept){\r\n        Span(Class: h5 text-success, Body: #votes_accept# ( #percent_accept# %))\r\n    }.Custom(custom_reject){\r\n        Span(Class: h5 text-danger, Body: #votes_reject# ( #percent_reject# %))\r\n    }.Custom(custom_voting){\r\n        SetVar(Name: participant_id, Value: 0)\r\n        DBFind(Name: referendums_participants, Source: src_referendums_participants).Where(\"referendum_id=#id# and member_id=#key_id#\").Vars(participant)\r\n        If(#participant_id# > 0){\r\n        }.Else{\r\n            Div(Class: pull-right){\r\n                Button(Body: Em(Class: fa fa-thumbs-down), Class: btn btn-danger, Contract: referendums_reject, Params: \"referendum_id=#id#\", Page: referendums_list)\r\n            }\r\n            Div(Class: pull-right){\r\n                Button(Body: Em(Class: fa fa-thumbs-up), Class: btn btn-success, Contract: referendums_accept, Params: \"referendum_id=#id#\", Page: referendums_list)\r\n            }\r\n        }\r\n    }.Custom(custom_question){\r\n        Span(Class: h6, Body: #question#)\r\n    }.Where(#v_Where#).Order(id)\r\n    \r\n    Div(Class: panel panel-primary){\r\n        Form(){\r\n            Div(Class: list-group-item){\r\n                Div(Class: row df f-valign){\r\n                    Div(Class: col-md-1 mt-sm text-right){\r\n                        Label(For: Search){\r\n                            Span(Body: LangRes(name))\r\n                        }\r\n                    }\r\n                    Div(Class: col-md-11 mc-sm){\r\n                        Div(Class: input-group){\r\n                            Input(Class: form-control, Type: text, Name: Search, Value: #v_Search#)\r\n                            Div(Class: input-group-btn){\r\n                                Button(Body: Em(Class: fa fa-search), Class: btn btn-default, Page: referendums_list, PageParams: \"isSearch=1,v_Search=Val(Search)\")\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            \r\n            Div(Class: list-group-item){\r\n                Table(src_referendums, \"$id$=custom_id,$name$=custom_name,$description$=custom_question,$votes_taken_accept$=custom_accept,$votes_taken_reject$=custom_reject,$total_votes$=custom_all,=custom_voting\")\r\n                If(GetVar(isSearch) == 1){\r\n                    Div(Class: text-center){\r\n                        Button(Body: $view_all$, Class: btn btn-primary, Page: referendums_list, PageParams: \"isSearch=0\")\r\n                    }\r\n                }\r\n            }\r\n            \r\n            Div(Class: panel-footer clearfix){\r\n                Div(Class: pull-right){\r\n                    Button(Body: LangRes(create), Class: btn btn-primary, Page: referendums_add)\r\n                }\r\n            }\r\n            \r\n        }\r\n    }\r\n}",
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Menu": "default_menu"
        },
        {
            "Name": "referendums_view",
            "Value": "Div(Class: content-wrapper){\r\n    If(#referendum_id# > 0){\r\n\r\n        DBFind(Name: referendums, Source: src_referendums).Where(\"id=#referendum_id#\").Vars(instance)\r\n        DBFind(Name: referendums_participants, Source: src_referendums_participants).Where(\"referendum_id=#referendum_id# and member_id=#key_id#\").Vars(participant)\r\n\r\n        SetTitle($referendum$: #instance_name#)\r\n        Div(Class: breadcrumb){\r\n            LinkPage($referendum$, referendums_list)\r\n            Span(/).Style(margin-right: 10px; margin-left: 10px;)\r\n            Span(Class: text-muted, Body: #instance_name#)\r\n        }\r\n\r\n        Div(Class: row df f-valign){\r\n            Div(Class: col-md-2)\r\n            Div(Class: col-md-8){\r\n\r\n                Div(Class: panel panel-default){\r\n                    Form(){ \r\n\r\n                        Div(Class: list-group-item text-center){\r\n                            P(Class: h2 text-bold m0, Body: #instance_name#)\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-12 mt-sm){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-muted m0, Body: LangRes(total_votes): #instance_votes_total#)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n                        }\r\n                        Div(Class: list-group-item text-center){\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm)\r\n                                Div(Class: col-md-8 mt-sm){\r\n\t\t\t\t\t\t\t\t\tP(Class: h4 text-normal m0, Body: #instance_question#)\r\n\t\t\t\t\t\t\t\t}\r\n                                Div(Class: col-md-2 mt-sm)\r\n\t\t\t\t\t\t\t}\r\n                        }\r\n                        Div(Class: list-group-item text-center){\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-4 mt-sm text-left){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-success m0, Body: LangRes(votes_taken_accept))\r\n                                }\r\n                                Div(Class: col-md-4 mt-sm text-right){\r\n\t\t\t\t\t\t\t\t\tP(Class: h5 text-danger m0, Body: LangRes(votes_taken_reject))\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-8 mt-sm text-center){\r\n                                    If(Or(#instance_percent_accept#>0,#instance_percent_reject#>0)){\r\n                                        Div().Style(background-color:green;height:10px;display:inline-block;width:#instance_percent_accept#%)\r\n                                        Div().Style(background-color:red;height:10px;display:inline-block;width:#instance_percent_reject#%)\r\n                                    }.Else{\r\n                                        Div().Style(background-color:LightGray;height:10px;display:inline-block;width:100%)\r\n                                    }\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n                            Div(Class: row df f-valign){\r\n                                Div(Class: col-md-2 mt-sm )\r\n                                Div(Class: col-md-4 mt-sm text-left){\r\n                                    P(Class: h5 text-success m0, Body: #instance_percent_accept# % (#instance_votes_accept#))\r\n                                }\r\n                                Div(Class: col-md-4 mt-sm text-right){\r\n                                    P(Class: h5 text-danger m0, Body: #instance_percent_reject# % (#instance_votes_reject#))\r\n                                }\r\n                                Div(Class: col-md-2 mt-sm)\r\n                            }\r\n\t\t\t\t\t\t}\r\n                        If(#participant_id# > 0){\r\n                        }.Else{\r\n                            Div(Class: list-group-item text-center){\r\n                                Div(Class: row df f-valign){\r\n                                    Div(Class: col-md-1 mt-sm )\r\n                                    Div(Class: col-md-5 mt-sm text-center){\r\n                                        Button(Body: Em(Class: fa fa-thumbs-up), Class: btn btn-success, Contract: referendums_accept, Params: \"referendum_id=#referendum_id#\", Page: referendums_view, PageParams: \"referendum_id=#referendum_id#\")\r\n                                    }\r\n                                    Div(Class: col-md-5 mt-sm text-center){\r\n                                        Button(Body: Em(Class: fa fa-thumbs-down), Class: btn btn-danger, Contract: referendums_reject, Params: \"referendum_id=#referendum_id#\", Page: referendums_view, PageParams: \"referendum_id=#referendum_id#\")\r\n                                    }\r\n                                    Div(Class: col-md-1 mt-sm)\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                    }\r\n                }\r\n\r\n            }\r\n            Div(Class: col-md-2)\r\n        }   \r\n    }.Else{\r\n        Div(Class: md-12 alert alert-danger text-center){\r\n            Span(Body: LangRes(attention))\r\n        }\r\n    }\r\n}",
            "Conditions": "ContractAccess(\"@1EditPage\")",
            "Menu": "default_menu"
        }
    ],
    "parameters": [],
    "tables": [
        {
            "Name": "referendums",
            "Columns": "[{\"name\":\"question\",\"type\":\"text\",\"conditions\":\"true\"},{\"name\":\"votes_total\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"votes_accept\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"votes_reject\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"percent_accept\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"percent_reject\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"name\",\"type\":\"text\",\"conditions\":\"true\"},{\"name\":\"delete\",\"type\":\"number\",\"conditions\":\"true\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        },
        {
            "Name": "referendums_participants",
            "Columns": "[{\"name\":\"decision\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"member_id\",\"type\":\"number\",\"conditions\":\"true\"},{\"name\":\"referendum_id\",\"type\":\"number\",\"conditions\":\"true\"}]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}"
        }
    ]
}