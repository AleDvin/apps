{
    "name": "Rope accounting",
    "data": [
        {
            "Conditions": "ContractAccess(\"@1EditMenu\")",
            "Value": "MenuItem(Title: \"Импортирование загрузки\", Page: rope_imports, Icon:\"fa fa-upload\")\nMenuItem(Title: \"Учет наработки\", Page: rope_works, Icon:\"icon-list\")\nMenuItem(Title:\"Рассогласования показаний датчиков\", Page:rope_depths, Icon:\"icon-list\")\nMenuItem(Title: \"Буровые\", Page: rope_drillings, Icon:\"icon-list\")\nMenuItem(Title: \"Бухты\", Page: rope_coils, Icon:\"icon-list\")",
            "Name": "default_menu",
            "Type": "menu"
        },
        {
            "Name": "rope_coils",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"certificate\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"deleted\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"diameter\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"length_full\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"length_rigging\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"previous_workout\",\n        \"type\": \"number\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "rope_depths",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"deleted\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"operation\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rope_drilling_id\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rope_coil_id\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"manufacturer_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"manufacturer_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"servicer_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"servicer_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"producer_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"producer_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"status_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"status_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"depth_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"depth_started\",\n        \"type\": \"number\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "rope_drillings",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"filial\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"deleted\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"expedition\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"brigade\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"master\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"block_weight\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"candle_length\",\n        \"type\": \"double\"\n    }\n    \n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Name": "rope_works",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"deleted\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"depth_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"depth_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"weight_final\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"weight_started\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"bypass_bracing\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"operation_date\",\n        \"type\": \"datetime\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"operation\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rope_drilling_id\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rope_coil_id\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"operation_type\",\n        \"type\": \"varchar\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"work_started\",\n        \"type\": \"double\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"work_final\",\n        \"type\": \"double\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"work_operation\",\n        \"type\": \"double\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"work_bypass\",\n        \"type\": \"double\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"work_coil\",\n        \"type\": \"double\"\n    }\n]",
            "Permissions": "{\"insert\":\"true\",\"update\":\"true\",\"new_column\":\"true\"}",
            "Type": "tables"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0.01",
            "Name": "rope_depth_error_rate",
            "Type": "app_params"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Name": "rope_manufacturer_role_id",
            "Type": "app_params"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Name": "rope_producer_role_id",
            "Type": "app_params"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "0",
            "Name": "rope_servicer_role_id",
            "Type": "app_params"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)SetVar(title,$create$).(btn_title,$create$)SetVar(item_certificate,)SetVar(item_length_full,)SetVar(item_length_rigging,)SetVar(item_previous_workout,)SetVar(item_deleted,)SetVar(item_diameter,)\r\nIf(GetVar(id)){\r\n    DBFind(rope_coils).Where(\"id=#id#\").Vars(item)\r\n    SetVar(title,$edit$).(btn_title,$edit$)\r\n}\r\nSetTitle(#title#)\r\nDiv(content-wrapper){\r\n    Div(breadcrumb){\r\n        LinkPage(Body: $rope_coils$, Page: rope_coils)\r\n        Span(/, mh)\r\n        Span(#title#, text-muted)\r\n    }\r\n    Div(row){\r\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\r\n            Form(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(data_input)\r\n                }\r\n                Div(panel-body){\r\n                    If(GetVar(id)){\r\n                        Input(Name: id, Type:hidden, Value: #id#)\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(certificate)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: certificate, Type:text, Value: #item_certificate#)\r\n                        }\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(length_full)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: lengthFull, Type:number, Value: #item_length_full#)\r\n                        }\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(length_rigging)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: lengthRigging, Type:number, Value: #item_length_rigging#)\r\n                        }\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(previous_workout)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: previousWorkout, Type:number, Value: #item_previous_workout#)\r\n                        }\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(deleted)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: deleted, Type:number, Value: #item_deleted#)\r\n                        }\r\n                    }\r\n                    Div(row mt-sm){\r\n                        Div(col-sm-4 mt-sm text-right){\r\n                            LangRes(diameter)\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            Input(Name: diameter, Type:number, Value: #item_diameter#)\r\n                        }\r\n                    }\r\n                }\r\n                Div(panel-footer text-right){\r\n                    Button(Body: Back, Page: rope_coils, Class: btn btn-default pull-left)\r\n                    Button(Body: #btn_title#, Page: rope_coils, Class: btn btn-primary, Contract: RopeCoilEdit)\r\n                }\r\n            }\r\n        }\r\n    }\r\n}",
            "Name": "rope_coil_edit",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "\r\nDBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\r\nIf(GetVar(id)){\r\n    DBFind(rope_coils).Where(\"id=#id#\").Vars(item)\r\n}\r\nSetTitle(title,$view$ ##id#)\r\nDiv(content-wrapper){\r\n    Div(breadcrumb){\r\n        LinkPage(Body: $rope_coils$, Page: rope_coils)\r\n        Span(/, mh)\r\n        Span(#title#, text-muted)\r\n    }\r\n    If(GetVar(id)){\r\n        Div(row){\r\n            Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\r\n                Div(panel panel-primary){\r\n                    Div(panel-heading){\r\n                        LangRes(data_view)\r\n                    }\r\n                    Div(panel-body){\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(certificate)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_certificate#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(length_full)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_length_full#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(length_rigging)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_length_rigging#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(previous_workout)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_previous_workout#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(deleted)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_deleted#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(diameter)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_diameter#\r\n                            }\r\n                        }\r\n\r\n                        Div(row mt-sm){\r\n                            Div(col-sm-4 mt-sm text-right text-bold){\r\n                                LangRes(id)\r\n                            }\r\n                            Div(col-sm-8 text-left){\r\n                                #item_id#\r\n                            }\r\n                        }\r\n                    }\r\n                    Div(panel-footer text-left){\r\n                        Button(Body: Back, Page: rope_coils, Class: btn btn-default)\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }.Else{\r\n        Div(h3 text-center){\r\n            LangRes(rope_item_not_found)\r\n        }\r\n    }\r\n}",
            "Name": "rope_coil_view",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\r\nSetTitle($rope_coils$)\r\nSetVar(page_name,rope_coils)\r\nDiv(content-wrapper){\r\n    AddToolButton(Title: Create, Page: rope_coil_edit, Icon: icon-plus)\r\n\r\n    DBFind(rope_coils).Count(count)\r\n    If(#page#>0){\r\n        SetVar(prev_page,Calculate(#page#-1)\r\n    }.Else{\r\n        SetVar(page,0).(prev_page,0)\r\n    }\r\n    SetVar(per_page,25).(off,Calculate(#page#*#per_page#)).(last_page,Calculate(#count#/#per_page#)).(next_page,#last_page#)\r\n    If(#count#>Calculate(#off#+#per_page#)){\r\n        SetVar(next_page,Calculate(#page#+1)\r\n    }\r\n    Div(button-group){\r\n        If(#page#>0){\r\n            Button(Body:\"1\", Class:btn btn-default, Page:#page_name#, PageParams: \"page=0\")\r\n        }.Else{\r\n            Button(Body:\"1\", Class:btn btn-default disabled)\r\n        }\r\n        If(#page#>1){\r\n            Button(Body:Calculate(#prev_page#+1),Class:btn btn-default, Page:#page_name#, PageParams:\"page=#prev_page#\")\r\n        }\r\n        If(And(#page#>0,#page#<#last_page#)){\r\n            Button(Body:Calculate(#page#+1), Class:btn btn-default disabled)\r\n        }\r\n        If(#next_page#<#last_page#){\r\n            Button(Body:Calculate(#next_page#+1),Class:btn btn-default,Page:#page_name#, PageParams:\"page=#next_page#\")\r\n        }\r\n        If(#page#<#last_page#){\r\n            Button(Body:Calculate(#last_page#+1), Class:btn btn-default, Page:#page_name#, PageParams:\"page=#last_page#\")\r\n        }.ElseIf(#last_page#>0){\r\n            Button(Body:Calculate(#last_page#+1), Class:btn btn-default disabled)\r\n        }\r\n    }\r\n    Div(panel panel-primary){\r\n        Div(panel-body){\r\n            Div(table-responsive){\r\n                DBFind(rope_coils,src_rope_coils).Offset(#off#).Order(id).Custom(_actions){\r\n                    Div(text-right text-nowrap){\r\n                        Button(Class: btn btn-info fa fa-eye mr-sm, Page: rope_coil_view, PageParams: \"id=#id#\")\r\n                        Button(Class: btn btn-default fa fa-edit mr-sm, Page: rope_coil_edit, PageParams: \"id=#id#\")\r\n                        Button(Class: btn btn-danger fa fa-trash, Page: rope_coils, Contract: RopeCoilDelete, Params: \"id=#id#\").Alert($delete_alert$, $yes$, $no$)\r\n                    }\r\n                }\r\n                Table(src_rope_coils,\"certificate,length_full,length_rigging,previous_workout,deleted,diameter,=_actions\")\r\n            }\r\n        }\r\n    }\r\n}",
            "Name": "rope_coils",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\nSetTitle($rope_depths$)\nDBFind(rope_depths).Where(\"deleted=0 and (status_final=0 or status_started=0)\").Count(count)\nSetVar(page_name,rope_depths)\nIf(#page#>0){\n    SetVar(prev_page,Calculate(#page#-1)\n}.Else{\n    SetVar(page,0).(prev_page,0)\n}\nSetVar(per_page,25).(off,Calculate(#page#*#per_page#)).(last_page,Calculate(#count#/#per_page#)).(next_page,#last_page#)\nIf(#count#>Calculate(#off#+#per_page#)){\n    SetVar(next_page,Calculate(#page#+1)\n}\n\nDiv(content-wrapper){\n    Div(text-right){\n        DBFind(buffer_data,data).Where(\"key='rope_import' and member_id=#key_id#\").Vars(buf)\n        If(And(#buf_id#>0,#count#>0)){\n            Button(Body: \"Автокоррекция\", Class: btn btn-default, Page: rope_works).CompositeContract(Name:RopeDepthsUpdateWrapper, Data: #buf_value#).CompositeContract(Name:RopeWorksCalculate)\n        }\n    }\n    If(#count#>0){\n        Div(button-group){\n            If(#page#>0){\n                Button(Body:\"1\", Class:btn btn-default, Page:#page_name#, PageParams: \"page=0\")\n            }.Else{\n                Button(Body:\"1\", Class:btn btn-default disabled)\n            }\n            If(#page#>1){\n                Button(Body:Calculate(#prev_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#prev_page#\")\n            }\n            If(And(#page#>0,#page#<#last_page#)){\n                Button(Body:Calculate(#page#+1), Class:btn btn-default disabled)\n            }\n            If(#next_page#<#last_page#){\n                Button(Body:Calculate(#next_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#next_page#\")\n            }\n            If(#page#<#last_page#){\n                Button(Body:Calculate(#last_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#last_page#\")\n            }.ElseIf(#last_page#>0){\n                Button(Body:Calculate(#last_page#+1), Class:btn btn-default disabled)\n            }\n        }\n        Form(panel panel-primary){\n            Div(panel-body){\n                Div(row){\n                    Div(col-md-12){\n                        Div(table-responsive){\n\n                            DBFind(rope_depths, src_depths).Custom(_started){\n                                If(#status_started#==0){\n                                    Div(text-warning){LangRes(rope_data_conflict)}\n\n                                    ArrayToSource(src_started#id#, [#manufacturer_started#,#producer_started#,#servicer_started#])\n                                    Select(Name: StartedValues, Source: src_started#id#,NameColumn: value, ValueColumn: value)\n                                    Input(Name: StartedIds, Type:hidden, Value: #id#)\n                                }.Else{\n                                    Div(text-success){LangRes(rope_data_confirmed)}\n                                    #depth_started#\n                                    Input(Name: StartedValues, Type:hidden, Value: 0)\n                                    Input(Name: StartedIds, Type:hidden, Value: 0)\n                                }\n                            }.Custom(_final){\n                                If(#status_final#==0){\n                                    Div(text-warning){LangRes(rope_data_conflict)}\n\n                                    ArrayToSource(src_final#id#, [#manufacturer_final#,#producer_final#,#servicer_final#])\n                                    Select(Name: FinalValues, Source: src_final#id#,NameColumn: value, ValueColumn: value)\n                                    Input(Name: FinalIds, Type:hidden, Value: #id#)\n                                }.Else{\n                                    Div(text-success){LangRes(rope_data_confirmed)}\n                                    #depth_final#\n                                    Input(Name: FinalValues, Type:hidden, Value: 0)\n                                    Input(Name: FinalIds, Type:hidden, Value: 0)\n                                }\n                            }.Where(\"deleted=0 and (status_final=0 or status_started=0)\").Order(\"id\").Offset(#off#)\n                            Table(src_depths,\"id,$rope_drilling_id$=rope_drilling_id,$rope_operation$=operation,$rope_depth_started$=_started,$rope_depth_final$=_final\")\n                        }\n                    }\n                }\n            }\n            Div(panel-footer text-right){\n                Button(Class: btn btn-primary, Body: send, Page: rope_depths, Contract: RopeDepthsUpdate, Params: \"Id=#id#,Value=#servicer_final#,Type=final\")\n            }\n        }\n    }.Else{\n        Div(row){\n            Div(text-center h3){\n                LangRes(rope_all_depths_ok)\n            }\n        }\n    }\n}.Style(\n    th,td {text-align:center;}\n    .radio {display:inline-block;margin-right:10px;}\n)",
            "Name": "rope_depths",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\nSetVar(left_col,\"col-sm-4 mt-sm text-right\").(right_col,\"col-sm-8 text-left\")\n\nSetVar(title,$rope_drilling_create$)\nSetVar(btn_title,$rope_create$)\nSetVar(drilling_filial,).(drilling_expedition,).(drilling_brigade,).(drilling_master,).(drilling_block_weight,).(drilling_candle_length,)\nIf(GetVar(Id)){\n    DBFind(rope_drillings).Where(\"id=#Id#\").Vars(drilling)\n    SetVar(title,$rope_drilling_edit$)\n    SetVar(btn_title,$rope_edit$)\n}\nSetTitle(#title#)\nDiv(content-wrapper){\n    Div(breadcrumb){\n        LinkPage(Body: $rope_drillings$, Page: rope_drillings)\n        Span(/, mh-sm)\n        Span(#title#, text-muted)\n    }\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading){\n                    LangRes($rope_data_input$)\n                }\n                Div(panel-body){\n                    If(GetVar(Id)){\n                        Input(Name: Id, Type:hidden, Value: #Id#)\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            LangRes(rope_filial)\n                        }\n                        Div(#right_col#){\n                            Input(Name: Filial, Value: #drilling_filial#)\n                        }\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            LangRes(rope_expedition)\n                        }\n                        Div(#right_col#){\n                            Input(Name: Expedition, Value: #drilling_expedition#)\n                        }\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            LangRes(rope_brigade)\n                        }\n                        Div(#right_col#){\n                            Input(Name: Brigade, Value: #drilling_brigade#)\n                        }\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            LangRes(rope_master)\n                        }\n                        Div(#right_col#){\n                            Input(Name: Master, Value: #drilling_master#)\n                        }\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            $rope_block_weight_full$, $rope_ton$\n                        }\n                        Div(#right_col#){\n                            Input(Name: BlockWeight, Type: number, Value: #drilling_block_weight#)\n                        }\n                    }\n                    Div(row mt-sm){\n                        Div(#left_col#){\n                            LangRes(rope_candle_length)\n                        }\n                        Div(#right_col#){\n                            Input(Name: CandleLength, Type:number, Value: #drilling_candle_length#)\n                        }\n                    }\n                }\n                Div(panel-footer text-right){\n                    Button(Body: #btn_title#, Page: rope_drillings, Class: btn btn-primary, Contract: RopeDrillingEdit)\n                }\n            }\n        }\n    }\n}",
            "Name": "rope_drilling_edit",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\nDBFind(rope_drillings,drillings).Count(count_drillings).Custom(_actions){\n    Div(text-right){\n        Button(Page: rope_drilling_edit, Class: btn btn-default fa fa-pencil mr-sm, PageParams: \"Id=#id#\")\n        Button(Page: rope_drilling_edit, Class: btn btn-danger fa fa-trash, Contract: RopeDrillingDelete, Params: \"Id=#id#\")\n    }\n}\nSetTitle($rope_drillings$)\nAddToolButton(Title: $rope_create$, Icon: icon-plus, Page: rope_drilling_edit)\nDiv(content-wrapper){\n    Div(panel panel-primary){\n        If(#count_drillings#>0){\n            Div(panel-body){\n                Div(table-responsive){\n                    Table(drillings,\"$rope_filial$=filial,$rope_expedition$=expedition,$rope_brigade$=brigade,$rope_master$=master,$rope_block_weight$=block_weight,$rope_candle_length$=candle_length,=_actions\")\n                }\n            }\n        }.Else{\n            Div(row){\n                Div(text-center h3){\n                    LangRes(rope_drillings_not_found)\n                }\n            }\n        }\n    }\n}",
            "Name": "rope_drillings",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\nDBFind(roles).Columns(\"role_name\").Where(\"id=#role_id#\").Vars(r)\n\nDBFind(binaries,binaries).Custom(_actions){\n    Div(text-right){\n        Button(Body: $rope_import$, Page: rope_works, Class: btn btn-primary, Contract: RopeBinaryParse, Params: \"Id=#id#\")\n    }\n}.Where(\"name='#r_role_name#_data_xlsm' and app_id=#application_id#\").Order(\"id desc\")\nAddToolButton(Title: \"Загрузить файл\", Icon: fa fa-upload, Page: rope_upload)\nDiv(content-wrapper){\n    SetTitle(\"Импортирование загрузки\")\n    Div(row){\n        Div(col-sm-10 col-sm-offset-1 col-lg-8 col-lg-offset-2){\n            Div(panel panel-primary){\n                Div(panel-body){\n                    Div(table-responsive){\n                        Table(binaries, \"=name,=data,=_actions\")\n                    }\n                }\n            }\n        }\n    }\n}.Style(\n    thead {display:none}\n)",
            "Name": "rope_imports",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "SetTitle($rope_upload$)\nDiv(content-wrapper){\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-body){\n                    Div(form-group){\n                        Input(Name: Data, Type: file)\n                    }\n                }\n                Div(panel-footer text-right){\n                    Button(Body: $rope_upload$, Page: rope_imports, Class: btn btn-primary, Contract: RopeUpload)\n                }\n            }\n        }\n    }\n}",
            "Name": "rope_upload",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"id\").Where(\"name='Rope accounting' AND deleted=0\").Vars(application)\nDBFind(rope_works).Count(count)\nSetTitle($rope_works$)\nSetVar(page_name,rope_works)\nIf(#page#>0){\n    SetVar(prev_page,Calculate(#page#-1)\n}.Else{\n    SetVar(page,0).(prev_page,0)\n}\nSetVar(per_page,25).(off,Calculate(#page#*#per_page#)).(last_page,Calculate(#count#/#per_page#)).(next_page,#last_page#)\nIf(#count#>Calculate(#off#+#per_page#)){\n    SetVar(next_page,Calculate(#page#+1)\n}\nDiv(content-wrapper){\n    Div(text-right){\n        Button(Body: $rope_recalculate$, Class: btn btn-default, Page: #page_name#, Contract: RopeWorksCalculate)\n    }\n    Div(button-group){\n        If(#page#>0){\n            Button(Body:\"1\", Class:btn btn-default, Page:#page_name#, PageParams: \"page=0\")\n        }.Else{\n            Button(Body:\"1\", Class:btn btn-default disabled)\n        }\n        If(#page#>1){\n            Button(Body:Calculate(#prev_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#prev_page#\")\n        }\n        If(And(#page#>0,#page#<#last_page#)){\n            Button(Body:Calculate(#page#+1), Class:btn btn-default disabled)\n        }\n        If(#next_page#<#last_page#){\n            Button(Body:Calculate(#next_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#next_page#\")\n        }\n        If(#page#<#last_page#){\n            Button(Body:Calculate(#last_page#+1), Class:btn btn-default, Page:#page_name#, PageParams: \"page=#last_page#\")\n        }.ElseIf(#last_page#>0){\n            Button(Body:Calculate(#last_page#+1), Class:btn btn-default disabled)\n        }\n    }\n    Div(panel panel-primary){\n        Div(panel-body){\n            Div(table-responsive){\n                DBFind(rope_works,works).Offset(#off#).Order(id).Custom(_date){\n                    Div(text-nowrap){\n                        DateTime(#operation_date#, DD-MM-YYYY)\n                    }\n                }.Custom(_type){\n                    Div(text-nowrap){\n                        #operation_type#\n                    }\n                }.Custom(_wb){\n                    SetVar(wb,Calculate(#work_bypass#, Prec:0))\n                    If(#wb#!=\"wrong expression\"){\n                        #wb#\n                    }\n                }.Custom(_ws){\n                    SetVar(ws,Calculate(#work_started#, Prec:0))\n                    If(#ws#!=\"wrong expression\"){\n                        #ws#\n                    }\n                }.Custom(_wf){\n                    SetVar(wf,Calculate(#work_final#, Prec:0))\n                    If(#wf#!=\"wrong expression\"){\n                        #wf#\n                    }\n                }.Custom(_wo){\n                    SetVar(wo,Calculate(#work_operation#, Prec:0))\n                    If(#wo#!=\"wrong expression\"){\n                        #wo#\n                    }\n                }.Custom(_wc){\n                    SetVar(wc,Calculate(#work_coil#, Prec:0))\n                    If(#wc#!=\"wrong expression\"){\n                        #wc#\n                    }\n                }\n                Table(works,\"$rope_drilling_id$=rope_drilling_id,$rope_operation$=operation,$rope_operation_date$=_date,$rope_operation_type$=_type,$rope_depth_started$=depth_started,$rope_depth_final$=depth_final,$rope_weight_started$=weight_started,$rope_weight_final$=weight_final,$rope_work_started$=_ws, $rope_work_final$=_wf, $rope_work_operation$=_wo, $rope_work_bypass$=_wb, $rope_work_coil$=_wc,$rope_bypass_bracing$=bypass_bracing\")\n            }\n        }\n    }\n}",
            "Name": "rope_works",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeRolesCondition {\r\n    data {}\r\n\r\n    conditions {\r\n        var appId int rid1 rid2 rid3 string\r\n        appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        rid1 = Int(AppParam(appId, \"rope_manufacturer_role_id\"))\r\n        rid2 = Int(AppParam(appId, \"rope_producer_role_id\"))\r\n        rid3 = Int(AppParam(appId, \"rope_servicer_role_id\"))\r\n        if rid1 == 0 {\r\n            warning \"'rope_manufacturer_role_id' not set\"\r\n        }\r\n        if rid2 == 0 {\r\n            warning \"'rope_producer_role_id' not set\"\r\n        }\r\n        if rid3 == 0 {\r\n            warning \"'rope_servicer_role_id' not set\"\r\n        }\r\n        if rid1 == rid2 || rid1 == rid3 || rid2 == rid3 {\r\n            warning \"Invalid set roles\"\r\n        }\r\n        if !($role_id == rid1 || $role_id == rid2 || $role_id == rid3){\r\n            warning \"Your role not allowed for this action\"\r\n        }\r\n    }\r\n}",
            "Name": "RopeRolesCondition",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeCoilDelete {\r\n    data {\r\n        id int\r\n    }\r\n    conditions {\r\n        if !DBFind(\"rope_coils\").Where(\"id=? and deleted=0\", $id).One(\"id\") {\r\n            warning \"Record not found\"\r\n        }\r\n    }\r\n    action {\r\n        DBUpdate(\"rope_coils\", $id, \"deleted\", 1)\r\n    }\r\n}",
            "Name": "RopeCoilDelete",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeCoilEdit {\r\n    data {\r\n        id string \"optional\"\r\n        certificate string\r\n        lengthFull int\r\n        lengthRigging int\r\n        previousWorkout int\r\n        deleted int\r\n        diameter int\r\n    }\r\n    conditions {\r\n        $id = Int($id)\r\n        if $id > 0{\r\n            if !DBFind(\"rope_coils\").Where(\"id=?\", $id).One(\"id\") {\r\n                warning \"Record not found\"\r\n            }\r\n        }\r\n    }\r\n    action {\r\n        if $id > 0{\r\n            DBUpdate(\"rope_coils\", $id, \"certificate,length_full,length_rigging,previous_workout,deleted,diameter\",$certificate,$lengthFull,$lengthRigging,$previousWorkout,$deleted,$diameter)\r\n        }else{\r\n            DBInsert(\"rope_coils\", \"certificate,length_full,length_rigging,previous_workout,deleted,diameter\",$certificate,$lengthFull,$lengthRigging,$previousWorkout,$deleted,$diameter)\r\n        }\r\n    }\r\n}",
            "Name": "RopeCoilEdit",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeBinaryParse {\r\n    data {\r\n        Id string \"optional\"\r\n    }\r\n    func getWorkIndexes(cells array) map{\r\n        var indexes map i cellsLen int s string\r\n        // default indexes\r\n        indexes[\"operation_date\"] = 3\r\n        indexes[\"operation\"] = 4\r\n        indexes[\"operation_type\"] = 5\r\n        indexes[\"depth_started\"] = 6\r\n        indexes[\"depth_final\"] = 7\r\n        indexes[\"weight_started\"] = 9\r\n        indexes[\"weight_final\"] = 10\r\n        indexes[\"bypass_bracing\"] = 17\r\n        cellsLen = Len(cells)\r\n        while i < cellsLen{\r\n            // correction indexes\r\n            s = ToLower(TrimSpace(cells[i]))\r\n            if HasPrefix(s, \"дата\") && Contains(s,\"операции\"){\r\n                indexes[\"operation_date\"] = i\r\n            }elif HasPrefix(s, \"№\") && Contains(s,\"операции\"){\r\n                indexes[\"operation\"] = i\r\n            }elif HasPrefix(s, \"вид\") && Contains(s,\"работ\") && Contains(s,\"рейса\"){\r\n                indexes[\"operation_type\"] = i\r\n            }elif HasPrefix(s, \"глубина\") && Contains(s,\"начала\"){\r\n                indexes[\"depth_started\"] = i\r\n            }elif HasPrefix(s, \"глубина\") && Contains(s,\"конце\") {\r\n                indexes[\"depth_final\"] = i\r\n            }elif HasPrefix(s, \"вес\") && Contains(s,\"крюке\") && Contains(s,\"начале\"){\r\n                indexes[\"weight_started\"] = i\r\n            }elif HasPrefix(s, \"вес\") && Contains(s,\"крюке\") && Contains(s,\"конце\"){\r\n                indexes[\"weight_final\"] = i\r\n            }elif HasPrefix(s, \"перепуск\") && Contains(s,\"перетяжка\"){\r\n                indexes[\"bypass_bracing\"] = i\r\n            }elif s == \"примечание\" {\r\n                break\r\n            }\r\n            i=i+1\r\n        }\r\n        return indexes\r\n    }\r\n    func parseWorks(titleCell string, rows array) array {\r\n        var i rowsLen int resultRows selectedRows array canCopy bool\r\n        rowsLen = Len(rows)\r\n        while i < rowsLen {\r\n            var cells array c cellsLen notEmptyCellCount int\r\n            cells = rows[i]\r\n            cellsLen = Len(cells)\r\n            while c < cellsLen {\r\n                if Size(cells[c]) > 0{\r\n                    notEmptyCellCount = notEmptyCellCount+1\r\n                }\r\n                if titleCell == cells[c] {\r\n                    canCopy = true\r\n                }\r\n                c = c+1\r\n            }\r\n            if canCopy && notEmptyCellCount > 0 {\r\n                selectedRows = Append(selectedRows, rows[i])\r\n            }\r\n            if canCopy && notEmptyCellCount == 0 {\r\n                break\r\n            }\r\n            i = i+1\r\n        }\r\n        var indexes map\r\n        indexes = getWorkIndexes(selectedRows[0])\r\n        rowsLen = Len(selectedRows)\r\n        i = 1\r\n        while i < rowsLen {\r\n            var work map row array\r\n            row = selectedRows[i]\r\n            work[\"depth_final\"] = Int(row[indexes[\"depth_final\"]])\r\n            work[\"depth_started\"] = Int(row[indexes[\"depth_started\"]])\r\n            work[\"weight_final\"] = Int(row[indexes[\"weight_final\"]])\r\n            work[\"weight_started\"] = Int(row[indexes[\"weight_started\"]])\r\n            work[\"bypass_bracing\"] = Int(row[indexes[\"bypass_bracing\"]])\r\n            work[\"operation_type\"] = row[indexes[\"operation_type\"]]\r\n            work[\"operation_date\"] = Int(row[indexes[\"operation_date\"]])\r\n            if work[\"operation_date\"] != 0{\r\n                // https://stackoverflow.com/a/6154953\r\n                work[\"operation_date\"] = (work[\"operation_date\"] - 25569) * 86400\r\n            }\r\n            work[\"operation\"] = Int(row[indexes[\"operation\"]])\r\n            if work[\"operation\"] {\r\n                // stored data row only if has operation\r\n                resultRows = Append(resultRows, work)\r\n            }\r\n            i=i+1\r\n        }\r\n        return resultRows\r\n    }\r\n    func parseCoil(rows array) map {\r\n        var coil map i int row array\r\n        i = 7 // start coil info\r\n        while i < 9 { // end coil info\r\n            row = rows[i]\r\n            if i == 7 {\r\n                coil[\"certificate\"] = row[6]\r\n                coil[\"diameter\"] = Int(row[9])\r\n            }elif i == 8 {\r\n                coil[\"length_full\"] = Int(row[6])\r\n                coil[\"length_rigging\"] = Int(row[7])\r\n                coil[\"previous_workout\"] = Int(row[17])\r\n            }\r\n            i = i+1\r\n        }\r\n        return coil\r\n    }\r\n    func parseDrilling(rows array) map {\r\n        var drilling map i int row array\r\n        i = 3 // start drilling info\r\n        while i < 9 { // end drilling info\r\n            row = rows[i]\r\n            if i == 3 {\r\n                drilling[\"filial\"] = row[6]\r\n            }elif i == 4 {\r\n                drilling[\"expedition\"] = row[6]\r\n            }elif i == 5 {\r\n                drilling[\"brigade\"] = row[6]\r\n            }elif i == 6 {\r\n                drilling[\"master\"] = row[6]\r\n                drilling[\"block_weight\"] = Int(row[17])\r\n            }elif i == 7 {\r\n                if row[17] == \"\"{\r\n                    drilling[\"candle_length\"] = 0.0\r\n                }else{\r\n                    drilling[\"candle_length\"] = Float(row[17])\r\n                }\r\n            }\r\n            i = i+1\r\n        }\r\n        return drilling\r\n    }\r\n    func getMapValues(m map, keys array) array {\r\n        var values array i keysLen int key string\r\n        keysLen = Len(keys)\r\n        while i < keysLen {\r\n            key = keys[i]\r\n            if Contains(key, \" \"){\r\n                var splittedKey array\r\n                splittedKey = Split(key, \" \")\r\n                key = splittedKey[1]\r\n            }\r\n            values = Append(values, m[key])\r\n            i=i+1\r\n        }\r\n        return values\r\n    }\r\n    func storeCoil(coil map) int {\r\n        var id int\r\n        id = Int(DBFind(\"rope_coils\").Where(\"certificate=? and diameter=?\", coil[\"certificate\"], coil[\"diameter\"]).One(\"id\"))\r\n        if id == 0{\r\n            var keys values array\r\n            keys = GetMapKeys(coil)\r\n            values = getMapValues(coil, keys)\r\n            id = DBInsert(\"rope_coils\", Join(keys, \",\"), values...)\r\n        }\r\n        return id\r\n    }\r\n    func storeDrilling(drilling map) int {\r\n        var id int\r\n        id = Int(DBFind(\"rope_drillings\").Where(\"filial=? and expedition=? and brigade=?\", drilling[\"filial\"], drilling[\"expedition\"], drilling[\"brigade\"]).One(\"id\"))\r\n        if id == 0{\r\n            var keys values array\r\n            keys = GetMapKeys(drilling)\r\n            values = getMapValues(drilling, keys)\r\n            id = DBInsert(\"rope_drillings\", Join(keys, \",\"), values...)\r\n        }\r\n        return id\r\n    }\r\n    func storeWorksDepths(coilId, drillingId int, works array) {\r\n        var i worksLen int workId depthId workKeys depthKeys depthWorkKeys fields string values array work map\r\n        worksLen = Len(works)\r\n        workKeys = \"operation_type,weight_final,weight_started,bypass_bracing,timestamp operation_date,operation\"\r\n        depthWorkKeys = \"depth_started,depth_final\"\r\n        depthKeys = Sprintf(\"%v,%v,rope_drilling_id,rope_coil_id\", $startedField, $finalField)\r\n\r\n        while i < worksLen {\r\n            work = works[i]\r\n            workId = DBFind(\"rope_works\").Where(\"rope_coil_id=? and rope_drilling_id=? and operation=?\", coilId, drillingId, work[\"operation\"]).One(\"id\")\r\n            if !workId {\r\n                values = getMapValues(work, Split(workKeys, \",\"))\r\n                values = Append(values,drillingId)\r\n                values = Append(values,coilId)\r\n                fields = workKeys + \",rope_drilling_id,rope_coil_id\"\r\n                DBInsert(\"rope_works\", fields, values...)\r\n            }\r\n            depthId = DBFind(\"rope_depths\").Where(\"rope_coil_id=? and rope_drilling_id=? and operation=?\", coilId, drillingId, work[\"operation\"]).One(\"id\")\r\n            values = getMapValues(work, Split(depthWorkKeys, \",\"))\r\n            values = Append(values,drillingId)\r\n            values = Append(values,coilId)\r\n            values = Append(values,work[\"operation\"])\r\n            fields = depthKeys + \",operation\"\r\n            if !depthId {\r\n                DBInsert(\"rope_depths\", fields, values...)\r\n            }else{\r\n                DBUpdate(\"rope_depths\", Int(depthId), fields, values...)\r\n            }\r\n            i=i+1\r\n        }\r\n    }\r\n    func extend(a, b array)array{\r\n        var i lena lenb int\r\n        lena = Len(a)\r\n        lenb = Len(b)\r\n        while i<lenb{\r\n            a[lena+i] = b[i]\r\n            i=i+1\r\n        }\r\n        return a\r\n    }\r\n    func findAll(table, where, columns string) array {\r\n        var full parts array limit offset int\r\n        limit = 250\r\n        while true {\r\n            parts = DBFind(table).Where(where).Columns(columns).Offset(offset).Limit(limit)\r\n            if Len(parts) > 0 {\r\n                if Len(full) == 0 {\r\n                    full = parts\r\n                }else{\r\n                    full = extend(full, parts)\r\n                }\r\n            }else{\r\n                break\r\n            }\r\n            offset = offset+limit\r\n        }\r\n        return full\r\n    }\r\n    func updateDepths(coilId, drillingId int) {\r\n        var startedIds startedValues finalIds finalValues depths array i depthsLen int depth map columns string\r\n        columns = Sprintf(\"id,%v,%v\", $startedField, $finalField)\r\n        depths = findAll(\"rope_depths\", Sprintf(\"rope_coil_id=%v and rope_drilling_id=%v and operation>0\", coilId, drillingId), columns)\r\n        depthsLen = Len(depths)\r\n        var buf array m map\r\n        while i < depthsLen {\r\n            depth = depths[i]\r\n            startedIds = Append(startedIds, depth[\"id\"])\r\n            finalIds = Append(finalIds, depth[\"id\"])\r\n            startedValues = Append(startedValues, depth[$startedField])\r\n            finalValues = Append(finalValues, depth[$finalField])\r\n            i=i+1\r\n        }\r\n        m[\"StartedIds\"] = JSONEncode(startedIds)\r\n        m[\"StartedValues\"] = JSONEncode(startedValues)\r\n        m[\"FinalIds\"] = JSONEncode(finalIds)\r\n        m[\"FinalValues\"] = JSONEncode(finalValues)\r\n        buf = Append(buf, m)\r\n        \r\n        buffer_Manager(\"Action,Key,Val\", \"set\", \"rope_import\", JSONEncode(buf))\r\n        // RopeDepthsUpdate(\"StartedIds,StartedValues,FinalIds,FinalValues\", startedIds, startedValues, finalIds, finalValues)\r\n    }\r\n\r\n    conditions {\r\n        $Id = Int($Id)\r\n        if $Id == 0 {\r\n            $Id = Int(DBFind(\"buffer_data\").Where(\"key='rope_upload' and member_id=?\", $key_id).One(\"value\"))\r\n        }\r\n        $binId = Int(DBFind(\"binaries\").Where(\"id=?\", $Id).One(\"id\"))\r\n        if $binId == 0 {\r\n            warning \"File not found\"\r\n        }\r\n        RopeRolesCondition()\r\n        var appId mid sid pid int\r\n        appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        mid = Int(AppParam(appId, \"rope_manufacturer_role_id\"))\r\n        sid = Int(AppParam(appId, \"rope_servicer_role_id\"))\r\n        pid = Int(AppParam(appId, \"rope_producer_role_id\"))\r\n        \r\n        if $role_id == mid {\r\n            $startedField = \"manufacturer_started\"\r\n            $finalField = \"manufacturer_final\"\r\n        \r\n        }elif $role_id == sid {\r\n            $startedField = \"servicer_started\"\r\n            $finalField = \"servicer_final\"\r\n        \r\n        }elif $role_id == pid {\r\n            $startedField = \"producer_started\"\r\n            $finalField = \"producer_final\"\r\n        }\r\n    }\r\n    action {\r\n        var line count sheet drillingId coilId int rows works array coil drilling map\r\n        sheet = 1\r\n        count = Int(Str(GetRowsCountXLSX($binId, sheet)))\r\n        rows = GetDataFromXLSX($binId, line, count, sheet)\r\n\r\n        coil = parseCoil(rows)\r\n        drilling = parseDrilling(rows)\r\n        works = parseWorks(\"Месторождение\", rows)\r\n\r\n        coilId = storeCoil(coil)\r\n        drillingId = storeDrilling(drilling)\r\n        storeWorksDepths(coilId, drillingId, works)\r\n        updateDepths(coilId, drillingId)\r\n    }\r\n}",
            "Name": "RopeBinaryParse",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeDepthsUpdate {\r\n    data {\r\n        StartedIds array\r\n        StartedValues array\r\n        FinalIds array\r\n        FinalValues array\r\n    }\r\n\r\n    func absF(n float) float{\r\n        if n < 0{\r\n            return -1 * n\r\n        }\r\n        return n\r\n    }\r\n    func isEqual(a, b int) bool {\r\n        var res bool avg float\r\n        res = true\r\n        if $errorRate == 0 {\r\n            if a != b{\r\n                res = false\r\n                break\r\n            }\r\n        }else{\r\n            avg = Float(a+b) / 2\r\n            if avg != 0{\r\n                res = absF(a-avg)/avg <= $errorRate && absF(b-avg)/avg <= $errorRate\r\n            }\r\n        }\r\n        return res\r\n    }\r\n    func isSameDepth(m map, depthType string) bool{\r\n        var a b c int\r\n        if depthType == \"started\" {\r\n            a = Int(m[\"manufacturer_started\"])\r\n            b = Int(m[\"servicer_started\"])\r\n            c = Int(m[\"producer_started\"])\r\n        }else{\r\n            a = Int(m[\"manufacturer_final\"])\r\n            b = Int(m[\"servicer_final\"])\r\n            c = Int(m[\"producer_final\"])\r\n        }\r\n        if a > 0 && b+c == 0 || b >0 && a+c == 0 || c>0 && a+b==0 {\r\n            return false\r\n        }\r\n        if 0 == a && a == b && b == c && c == a {\r\n            return true\r\n        }\r\n        return isEqual(a,b) || isEqual(a,c) || isEqual(b,c)\r\n    }\r\n    func notesRefresh(did, cid string){\r\n        var depthsLen i notesLen int notes array note map\r\n        depthsLen = Len(DBFind(\"rope_depths\").Where(\"deleted=0 and rope_drilling_id=? and rope_coil_id=? and (status_started=0 or status_final=0) and operation>0\", did, cid))\r\n        notes = DBFind(\"notifications\").Where(\"page_params->rope_drilling_id=? and page_params->rope_coil_id=?\", did, cid)\r\n        notesLen = Len(notes)\r\n\r\n        if depthsLen == 0 && notesLen > 0{\r\n            // closing notes\r\n            while i < notesLen {\r\n                note = notes[i]\r\n                notifications_Close(\"notific_id\", Int(note[\"id\"]))\r\n                i = i + 1\r\n            }\r\n        }else{\r\n            if depthsLen > 0 && notesLen == 0{\r\n                // sending notes\r\n                var rid closureType sender int textHeader pageName string params map\r\n                closureType = 2\r\n                sender = 1\r\n                textHeader = \"Need your action: correct depths\"\r\n                pageName = \"rope_depths\"\r\n                params[\"rope_drilling_id\"] = did\r\n                params[\"rope_coil_id\"] = cid\r\n                params = JSONEncode(params)\r\n                rid = Int(AppParam($appId, \"rope_manufacturer_role_id\"))\r\n                notifications_Send(\"rid,closure_type,sender,text_header,page_name,params_map\", rid, closureType, sender, textHeader, pageName, params)\r\n\r\n                rid = Int(AppParam($appId, \"rope_servicer_role_id\"))\r\n                notifications_Send(\"rid,closure_type,sender,text_header,page_name,params_map\", rid, closureType, sender, textHeader, pageName, params)\r\n\r\n                rid = Int(AppParam($appId, \"rope_producer_role_id\"))\r\n                notifications_Send(\"rid,closure_type,sender,text_header,page_name,params_map\", rid, closureType, sender, textHeader, pageName, params)\r\n            }\r\n        }\r\n    }\r\n    func calculateValues(type string){\r\n        Println(\"calculateValues\", type)\r\n        var ids values array i lenIds int depthField fields workField string\r\n        depthField = Sprintf(\"%v_%v\", $userRoles[Str($role_id)], type)\r\n\r\n        if type == \"started\"{\r\n            ids = $StartedIds\r\n            values = $StartedValues\r\n            fields = Sprintf(\"status_started,depth_started,%v\", depthField)\r\n            workField = \"depth_started\"\r\n        }\r\n        if type == \"final\"{\r\n            ids = $FinalIds\r\n            values = $FinalValues\r\n            fields = Sprintf(\"status_final,depth_final,%v\", depthField)\r\n            workField = \"depth_final\"\r\n        }\r\n        lenIds = Len(ids)\r\n        var id value int row map did cid where string\r\n        while i < lenIds {\r\n            id = Int(ids[i])\r\n            value = Int(values[i])\r\n            if id > 0{\r\n                row = DBFind(\"rope_depths\").Where(\"id=?\", id).Row()\r\n                if !(did == row[\"rope_drilling_id\"] || cid == row[\"rope_coil_id\"]){\r\n                    did = row[\"rope_drilling_id\"]\r\n                    cid = row[\"rope_coil_id\"]\r\n                    notesRefresh(did, cid)\r\n                }\r\n                row[depthField] = value\r\n                if isSameDepth(row, type) {\r\n                    var workId int\r\n                    workId = Int(DBFind(\"rope_works\").Where(\"rope_coil_id=? and rope_drilling_id=? and operation=?\", cid, did, row[\"operation\"]).One(\"id\"))\r\n                    if workId > 0{\r\n                        DBUpdate(\"rope_works\", workId, workField, value)\r\n                        DBUpdate(\"rope_depths\", id, fields, 1, value, value)\r\n                    }\r\n                }else{\r\n                    DBUpdate(\"rope_depths\", id, depthField, value)\r\n                }\r\n            }\r\n            i = i + 1\r\n        }\r\n    }\r\n\r\n    conditions {\r\n        RopeRolesCondition()\r\n        $appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        var userRoles map\r\n        userRoles[AppParam($appId, \"rope_manufacturer_role_id\")] = \"manufacturer\"\r\n        userRoles[AppParam($appId, \"rope_servicer_role_id\")] = \"servicer\"\r\n        userRoles[AppParam($appId, \"rope_producer_role_id\")] = \"producer\"\r\n        $userRoles = userRoles\r\n        $errorRate = Float(AppParam($appId, \"rope_depth_error_rate\"))\r\n    }\r\n\r\n    action {\r\n        calculateValues(\"started\")\r\n        calculateValues(\"final\")\r\n    }\r\n}",
            "Name": "RopeDepthsUpdate",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeDrillingDelete {\r\n    data {\r\n        Id int\r\n    }\r\n\r\n    conditions {\r\n        if !DBFind(\"rope_drillings\").Where(\"id=?\", $Id).One(\"id\"){\r\n            warning \"The drilling not found\"\r\n        }\r\n    }\r\n    action {\r\n        DBUpdate(\"rope_drillings\", $Id, \"deleted\", 1)\r\n    }\r\n}",
            "Name": "RopeDrillingDelete",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeDrillingEdit {\r\n    data {\r\n        Id string \"optional\"\r\n        Filial string\r\n        Expedition string\r\n        Brigade string\r\n        Master string \"optional\"\r\n        BlockWeight int\r\n        CandleLength float\r\n    }\r\n\r\n    conditions {\r\n        $Id = Int($Id)\r\n        var appId int\r\n        appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        if DBFind(\"rope_drillings\").Where(\"deleted=0 and filial=?\",$Filial).One(\"id\"){\r\n            warning \"The filial name of the drill is already in use, please specify another name\"\r\n        }\r\n        if $Id > 0 {\r\n            if !DBFind(\"rope_drillings\").Where(\"id=?\", $Id).One(\"id\"){\r\n                warning \"The drilling not found\"\r\n            }\r\n        }\r\n    }\r\n    action {\r\n        if $Id > 0 {\r\n            DBUpdate(\"rope_drillings\", $Id, \"filial,expedition,brigade,master,block_weight,candle_length\", $Filial, $Expedition, $Brigade, $Master, $BlockWeight, $CandleLength)\r\n        }else{\r\n            DBInsert(\"rope_drillings\", \"filial,expedition,brigade,master,block_weight,candle_length\", $Filial, $Expedition, $Brigade, $Master, $BlockWeight, $CandleLength)\r\n        }\r\n    }\r\n}",
            "Name": "RopeDrillingEdit",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeDepthsUpdateWrapper {\r\n    data {\r\n        StartedIds string\r\n        StartedValues string\r\n        FinalIds string\r\n        FinalValues string\r\n    }\r\n\r\n    conditions {}\r\n\r\n    action {\r\n        RopeDepthsUpdate(\r\n            \"StartedIds,StartedValues,FinalIds,FinalValues\",\r\n            JSONDecode($StartedIds),\r\n            JSONDecode($StartedValues),\r\n            JSONDecode($FinalIds),\r\n            JSONDecode($FinalValues)\r\n        )\r\n    }\r\n}",
            "Name": "RopeDepthsUpdateWrapper",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeUpload {\r\n    data {\r\n        Data string \"file\"\r\n    }\r\n\r\n    conditions {\r\n        $appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        RopeRolesCondition()\r\n        $roleName = DBFind(\"roles\").Where(\"id=?\",$role_id).One(\"role_name\")\r\n    }\r\n    action {\r\n        var fileName string binId int\r\n        fileName = Sprintf(\"%v_%v_xlsm\", $roleName, \"data\")\r\n        binId = @1UploadBinary(\"Name,Data,ApplicationId,DataMimeType\", fileName, $Data, $appId, $DataMimeType)\r\n        buffer_Manager(\"Action,Key,Val\", \"set\", \"rope_upload\", Str(binId))\r\n    }\r\n}",
            "Name": "RopeUpload",
            "Type": "contracts"
        },
        {
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract RopeWorksCalculate {\r\n    data {}\r\n    func extend(a, b array)array{\r\n        var i lena lenb int\r\n        lena = Len(a)\r\n        lenb = Len(b)\r\n        while i<lenb{\r\n            a[lena+i] = b[i]\r\n            i=i+1\r\n        }\r\n        return a\r\n    }\r\n    func findAll(table, where, columns string) array {\r\n        var full parts array limit offset int\r\n        limit = 250\r\n        while true {\r\n            parts = DBFind(table).Where(where).Columns(columns).Offset(offset).Limit(limit)\r\n            if Len(parts) > 0 {\r\n                if Len(full) == 0 {\r\n                    full = parts\r\n                }else{\r\n                    full = extend(full, parts)\r\n                }\r\n            }else{\r\n                break\r\n            }\r\n            offset = offset+limit\r\n        }\r\n        return full\r\n    }\r\n    func getAbsFloat(n float) float{\r\n        if n < 0{\r\n            return -1 * n\r\n        }\r\n        return n\r\n    }\r\n    func safeFloat(num ...)float{\r\n        var res float\r\n        if Len(num) != 0{\r\n            if num[0] {\r\n                res = Float(num[0])\r\n            }\r\n        }\r\n        return res\r\n    }\r\n    func getMapValues(m map, keys array) array {\r\n        var values array i keysLen int key string\r\n        keysLen = Len(keys)\r\n        while i < keysLen {\r\n            key = keys[i]\r\n            values = Append(values, m[key])\r\n            i=i+1\r\n        }\r\n        return values\r\n    }\r\n    conditions {\r\n        RopeRolesCondition()\r\n        $appId = Int(DBFind(\"applications\").Columns(\"id\").Where(\"name='Rope accounting'\").One(\"id\"))\r\n        var userRoles map\r\n        userRoles[AppParam($appId, \"rope_manufacturer_role_id\")] = \"manufacturer\"\r\n        userRoles[AppParam($appId, \"rope_servicer_role_id\")] = \"servicer\"\r\n        userRoles[AppParam($appId, \"rope_producer_role_id\")] = \"producer\"\r\n        $userRoles = userRoles\r\n        $errorRate = safeFloat(AppParam($appId, \"rope_depth_error_rate\"))\r\n    }\r\n\r\n    action {\r\n        Println($this_contract)\r\n        var works array cols op string i lenWorks int work workPrev coil drilling map\r\n        works = findAll(\"rope_works\", \"id>0\", cols)\r\n        lenWorks = Len(works)\r\n\r\n        var w1 w2 d1 d2 cl bw pw float\r\n        while i<lenWorks {\r\n            if i > 0 {\r\n                workPrev = work\r\n            }\r\n            work = JSONDecode(JSONEncode(works[i])) // [string]string => [string]interface{}\r\n            if work[\"rope_coil_id\"] != coil[\"id\"]{\r\n                coil = DBFind(\"rope_coils\").Where(\"id=?\", work[\"rope_coil_id\"]).Row()\r\n            }\r\n            if work[\"rope_drilling_id\"] != drilling[\"id\"]{\r\n                drilling = DBFind(\"rope_drillings\").Where(\"id=?\", work[\"rope_drilling_id\"]).Row()\r\n                cl = safeFloat(drilling[\"candle_length\"])\r\n                bw = safeFloat(drilling[\"block_weight\"])\r\n                pw = safeFloat(drilling[\"previous_workout\"])\r\n            }\r\n            op = work[\"operation_type\"]\r\n            w1 = safeFloat(work[\"weight_started\"])\r\n            w2 = safeFloat(work[\"weight_final\"])\r\n            d1 = safeFloat(work[\"depth_started\"])\r\n            d2 = safeFloat(work[\"depth_final\"])\r\n\r\n            // \"Наработка Lн, тк.м\"\r\n            work[\"work_started\"] = (w1 * (d1 + cl) + (4 * d1 * bw))/1000.0\r\n\r\n            // \"Наработка Lк, т.км\"\r\n            work[\"work_final\"] = (w2 * (d2 + cl) + (4 * d2 * bw))/1000.0\r\n\r\n            // \"Наработка за операцию, т.км\"\r\n            if op == \"Подъем\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*0.5\r\n            }elif op == \"Спуск\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*0.5\r\n            }elif op == \"СПО\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])\r\n            }elif op == \"Бурение\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*3\r\n            }elif op == \"Отбор керна\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*2\r\n            }elif op == \"Проработка\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*2\r\n            }elif op == \"Шаблонировка\"{\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])*2\r\n            }elif op == \"Спуск обсадной колонны\"{\r\n                work[\"work_operation\"] = work[\"work_final\"]*0.5\r\n            }elif op == \"Технологическое СПО\" {\r\n                work[\"work_operation\"] = getAbsFloat(work[\"work_final\"] - work[\"work_started\"])\r\n            }elif op == \"Аварийные работы\"{\r\n                work[\"work_operation\"] = work[\"work_final\"]*2\r\n            }else{\r\n                work[\"work_operation\"] = 0\r\n            }\r\n\r\n\r\n            // \"Наработка нарастающая до перепуска\"\r\n            if work[\"operation\"] == 1 {\r\n                work[\"work_bypass\"] = work[\"work_operation\"]\r\n            }elif work[\"work_operation\"] == 0 {\r\n                work[\"work_bypass\"] = 0\r\n            }else{\r\n                work[\"work_bypass\"] = work[\"work_operation\"] + workPrev[\"work_bypass\"]\r\n            }\r\n            // \"Наработка нарастающая на бухту\"\r\n            if work[\"operation\"] == 1 {\r\n                work[\"work_coil\"] = work[\"work_bypass\"] + pw\r\n            }else{\r\n                work[\"work_coil\"] = work[\"work_operation\"] + safeFloat(workPrev[\"work_coil\"])\r\n            }\r\n\r\n            var keys values array\r\n            keys = GetMapKeys(work)\r\n            values = getMapValues(work, keys)\r\n            DBUpdate(\"rope_works\", Int(work[\"id\"]), Join(keys,\",\"), values...)\r\n            i=i+1\r\n        }\r\n\r\n    }\r\n}",
            "Name": "RopeWorksCalculate",
            "Type": "contracts"
        }
    ]
}